<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼˜é›…é˜…è¯»å™¨</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/gbk.js@0.3.0/dist/gbk.min.js"></script>
    <script>
        // å®‰å…¨åœ°å¼•å…¥ Electron
        let ipcRenderer;
        let pathModule;
        let isWebMode = false;
        try {
            const electron = require('electron');
            ipcRenderer = electron.ipcRenderer;
            pathModule = require('path');
            console.log('Electron æˆåŠŸåŠ è½½');
        } catch (error) {
            console.log('Electron åŠ è½½å¤±è´¥ï¼Œåˆ‡æ¢åˆ° Web æ¨¡å¼');
            isWebMode = true;
            // Web æ¨¡å¼ä¸‹çš„ ipcRenderer æ¨¡æ‹Ÿ
            ipcRenderer = {
                invoke: async (channel, ...args) => {
                    console.log(`[Web API] è°ƒç”¨: ${channel}`, args);
                    try {
                        const response = await fetch('/api/invoke', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ channel, args })
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const result = await response.json();
                        if (result.error) {
                            throw new Error(result.error);
                        }

                        // ç‰¹æ®Šå¤„ç† Buffer æ•°æ®
                        if (result.data && result.data.type === 'Buffer' && Array.isArray(result.data.data)) {
                            return Uint8Array.from(result.data.data);
                        }

                        return result.data;
                    } catch (e) {
                        console.error(`[Web API] è°ƒç”¨å¤±è´¥: ${channel}`, e);
                        if (channel === 'select-directory') {
                            // Web æ¨¡å¼ä¸‹è¿”å› nullï¼Œç”±è°ƒç”¨æ–¹å¤„ç†
                            return null;
                        }
                        throw e;
                    }
                },
                on: () => { },
                removeListener: () => { }
            };
        }
    </script>
</head>

<body>
    <div class="loading-overlay" id="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-message">åŠ è½½ä¸­...</div>
        </div>
    </div>

    <div class="reader-container">
        <div class="reader-header">
            <h1 id="book-title">ä¼˜é›…é˜…è¯»å™¨</h1>
        </div>

        <div class="reader-main">
            <div class="reader-content" id="content">
                <p>è¯·é€‰æ‹©ä¸€ä¸ª TXT æ–‡ä»¶å¼€å§‹é˜…è¯»</p>
                <p style="color: #666; font-size: 14px;">æç¤ºï¼šä¸ºè·å¾—æœ€ä½³é˜…è¯»ä½“éªŒï¼Œå»ºè®®ä½¿ç”¨ UTF-8 ç¼–ç çš„ TXT æ–‡ä»¶</p>
                <p style="color: #666; font-size: 14px;">æ”¯æŒå¤šç§ç¼–ç æ ¼å¼ï¼šUTF-8ã€GBKã€Big5ã€Shift-JISã€EUC-KRã€UTF-16ç­‰</p>
                <p style="color: #666; font-size: 14px;">æç¤ºï¼šåœ¨ä¸»é¡µå’Œé˜…è¯»é¡µé¢å¯ä»¥åˆ†åˆ«è°ƒæ•´å­—ä½“å¤§å°</p>
            </div>

            <div class="reader-sidebar">
                <div class="setting-item">
                    <label for="file-input" class="setting-item">
                        <i class="icon">ğŸ“‚</i>
                        <span>é€‰æ‹©</span>
                    </label>
                    <input type="file" id="file-input" accept=".txt" style="display: none;">
                </div>
                <div class="setting-item" id="random-book-btn">
                    <i class="icon">ğŸ²</i>
                    <span>éšæœº</span>
                </div>
                <div class="setting-item" id="library-btn">
                    <i class="icon">ğŸ“š</i>
                    <span>ä¹¦åº“</span>
                </div>
                <div class="setting-item" onclick="toggleChapterList()">
                    <i class="icon">â‰¡</i>
                    <span>ç›®å½•</span>
                </div>
                <div class="setting-item" onclick="toggleTheme()">
                    <i class="icon">â˜¾</i>
                    <span>å¤œé—´</span>
                </div>
                <div class="setting-item" onclick="toggleFontSettings()">
                    <i class="icon">Aa</i>
                    <span>å­—ä½“</span>
                </div>
                <div class="setting-item" onclick="changeFontSize(1)">
                    <i class="icon">A+</i>
                    <span>å¢å¤§</span>
                </div>
                <div class="setting-item" onclick="changeFontSize(-1)">
                    <i class="icon">A-</i>
                    <span>å‡å°</span>
                </div>
                <div class="setting-item" onclick="backToHome()">
                    <i class="icon">âŒ‚</i>
                    <span>ä¸»é¡µ</span>
                </div>
            </div>
        </div>

        <div class="reader-controls">
            <div class="progress-indicator">
                <div class="progress-bar">
                    <div class="progress-inner" id="progress-bar"></div>
                </div>
                <div class="progress-text">
                    <span id="progress-percentage">0%</span>
                </div>
            </div>
            <div class="navigation-buttons">
                <button onclick="previousPage()">ä¸Šä¸€é¡µ</button>
                <span id="page-info">ç¬¬ 1 é¡µ</span>
                <button onclick="nextPage()">ä¸‹ä¸€é¡µ</button>
            </div>
            <div class="reading-options">
                <label class="option-label">ç¿»é¡µæ–¹å¼:
                    <select id="page-turn-mode">
                        <option value="page">åˆ†é¡µ</option>
                        <option value="scroll">æ»šåŠ¨</option>
                    </select>
                </label>
            </div>
        </div>
    </div>

    <div id="chapter-list" class="chapter-list hidden"></div>

    <!-- è‡ªå®šä¹‰å³é”®èœå• -->
    <div id="context-menu" class="context-menu" style="display: none;">
        <div class="context-menu-item" id="menu-copy">å¤åˆ¶é€‰ä¸­æ–‡æœ¬</div>
        <div class="context-menu-item" id="menu-translate">ç¿»è¯‘é€‰ä¸­æ–‡æœ¬</div>
        <div class="context-menu-item" id="menu-search">æœç´¢é€‰ä¸­æ–‡æœ¬</div>
        <div class="context-menu-item" id="menu-tts">æœ—è¯»é€‰ä¸­æ–‡æœ¬</div>
    </div>

    <!-- å­—ä½“è®¾ç½®é¢æ¿ -->
    <div id="font-settings-panel" class="settings-panel hidden">
        <div class="settings-panel-header">
            <h3>å­—ä½“è®¾ç½®</h3>
            <button class="close-btn" onclick="toggleFontSettings()">Ã—</button>
        </div>
        <div class="settings-panel-content">
            <div class="setting-group">
                <label>å­—ä½“ï¼š</label>
                <select id="font-family-selector" onchange="changeFontFamily()">
                    <option value="'Microsoft YaHei', 'PingFang SC', sans-serif">å¾®è½¯é›…é»‘</option>
                    <option value="'SimSun', serif">å®‹ä½“</option>
                    <option value="'KaiTi', serif">æ¥·ä½“</option>
                    <option value="'FangSong', serif">ä»¿å®‹</option>
                    <option value="'STXihei', sans-serif">åæ–‡ç»†é»‘</option>
                    <option value="'Source Han Sans CN', sans-serif">æ€æºé»‘ä½“</option>
                </select>
            </div>
            <div class="setting-group">
                <label>è¡Œé«˜ï¼š</label>
                <input type="range" id="line-height-slider" min="1.2" max="2.5" step="0.1" value="1.8"
                    onchange="changeLineHeight()">
                <span id="line-height-value">1.8</span>
            </div>
            <div class="setting-group">
                <label>å­—é—´è·ï¼š</label>
                <input type="range" id="letter-spacing-slider" min="0" max="0.15" step="0.01" value="0"
                    onchange="changeLetterSpacing()">
                <span id="letter-spacing-value">0</span>
            </div>
            <div class="setting-group">
                <label>æ®µè½é—´è·ï¼š</label>
                <input type="range" id="paragraph-spacing-slider" min="0.6" max="2" step="0.1" value="0.8"
                    onchange="changeParagraphSpacing()">
                <span id="paragraph-spacing-value">0.8em</span>
            </div>
        </div>
    </div>

    <script>
        let currentContent = [];
        let currentPage = 0;
        let currentFileName = '';
        let chapters = [];
        let currentChapter = 0;
        let fontSize = 18; // é˜…è¯»å†…å®¹çš„å­—ä½“å¤§å°
        let homePageFontSize = 16; // ä¸»é¡µå­—ä½“å¤§å°
        let baseDir = ''; // éšæœºé˜…è¯»çš„è·¯å¾„
        let searchDirs = []; // å†å²è®°å½•æœç´¢è·¯å¾„åˆ—è¡¨
        let wordsPerPage = 4000;

        document.getElementById('file-input').addEventListener('change', async function (e) {
            const file = e.target.files[0];
            if (!file) return;

            // è‡ªåŠ¨æ·»åŠ æ–‡ä»¶æ‰€åœ¨ç›®å½•åˆ°æœç´¢è·¯å¾„
            if (file.path && pathModule) {
                try {
                    const fileDir = pathModule.dirname(file.path);
                    // æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨æœç´¢è·¯å¾„ä¸­
                    if (!searchDirs.includes(fileDir)) {
                        searchDirs.push(fileDir);

                        // ä¿å­˜é…ç½®
                        await ipcRenderer.invoke('save-config', {
                            searchDirs: searchDirs
                        });
                        console.log(`å·²è‡ªåŠ¨æ·»åŠ æœç´¢è·¯å¾„: ${fileDir}`);
                    }
                } catch (err) {
                    console.error('è‡ªåŠ¨æ·»åŠ æœç´¢è·¯å¾„å¤±è´¥:', err);
                }
            }

            currentFileName = file.name;
            document.getElementById('loading-overlay').style.display = 'flex';
            document.querySelector('.loading-message').textContent = 'å‡†å¤‡åŠ è½½æ–‡ä»¶...';

            // ä½¿ç”¨åˆ†å—è¯»å–æ–¹å¼å¤„ç†å¤§æ–‡ä»¶
            const CHUNK_SIZE = 1024 * 1024 * 4; // 4MB åˆ†å—å¤§å°
            let fileSize = file.size;
            let offset = 0;
            let fileReader = new FileReader();
            let chunks = [];
            let loadedSize = 0;

            // åˆ›å»ºä¸€ä¸ª Web Worker æ¥å¤„ç†æ–‡ä»¶è§£ç ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹
            const fileWorker = createFileWorker();

            fileReader.onload = function (e) {
                if (e.target.result) {
                    chunks.push(e.target.result);
                    loadedSize += e.target.result.byteLength;

                    // æ›´æ–°åŠ è½½è¿›åº¦
                    const progress = Math.round((loadedSize / fileSize) * 100);
                    document.querySelector('.loading-message').textContent = `åŠ è½½ä¸­...${progress}%`;

                    // ç»§ç»­è¯»å–ä¸‹ä¸€å—
                    offset += CHUNK_SIZE;
                    if (offset < fileSize) {
                        readNextChunk();
                    } else {
                        // æ‰€æœ‰å—éƒ½å·²è¯»å–å®Œæˆï¼Œå¼€å§‹å¤„ç†æ–‡ä»¶å†…å®¹
                        document.querySelector('.loading-message').textContent = 'æ­£åœ¨å¤„ç†æ–‡ä»¶å†…å®¹...';

                        // åˆå¹¶æ‰€æœ‰å—
                        const completeBuffer = mergeArrayBuffers(chunks);

                        // ä½¿ç”¨ Worker å¤„ç†æ–‡ä»¶è§£ç ï¼Œå¹¶ä½¿ç”¨ Transferable Objects è½¬ç§»æ‰€æœ‰æƒï¼Œé¿å…æ‹·è´
                        fileWorker.postMessage({
                            buffer: completeBuffer,
                            fileName: file.name
                        }, [completeBuffer]);
                    }
                }
            };

            fileReader.onerror = function (e) {
                console.error("æ–‡ä»¶è¯»å–é”™è¯¯:", e);
                alert("æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼å’Œç¼–ç ã€‚");
                document.getElementById('loading-overlay').style.display = 'none';
            };

            // å¤„ç† Worker è¿”å›çš„ç»“æœ
            fileWorker.onmessage = function (e) {
                const result = e.data;
                if (result.error) {
                    console.error("æ–‡ä»¶å¤„ç†é”™è¯¯:", result.error);
                    alert("æ–‡ä»¶å¤„ç†å¤±è´¥: " + result.error);
                    document.getElementById('loading-overlay').style.display = 'none';
                    return;
                }

                const text = result.text;
                const encoding = result.encoding || 'æœªçŸ¥';

                // æ˜¾ç¤ºæ£€æµ‹åˆ°çš„ç¼–ç 
                showNotification(`æ£€æµ‹åˆ°æ–‡ä»¶ç¼–ç : ${encoding}`);

                // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„è¿›åº¦ï¼Œä»å¤šä¹¦ç±è¿›åº¦å­˜å‚¨ä¸­è·å–
                const allBookProgress = JSON.parse(localStorage.getItem('allBookProgress')) || {};

                // ä¼˜å…ˆä½¿ç”¨ window.pendingPosition (æ¥è‡ªå†å²è®°å½•ç‚¹å‡»)
                if (window.pendingPosition !== undefined) {
                    currentPage = window.pendingPosition;
                    currentChapter = window.pendingChapter || 0;
                    // æ¸…ç†ä¸´æ—¶å˜é‡
                    window.pendingPosition = undefined;
                    window.pendingChapter = undefined;
                } else if (allBookProgress[currentFileName]) {
                    currentPage = allBookProgress[currentFileName].page;
                    currentChapter = allBookProgress[currentFileName].chapter;
                } else {
                    currentPage = 0;
                    currentChapter = 0;
                }

                document.getElementById('book-title').textContent = file.name.replace('.txt', '');
                document.querySelector('.loading-message').textContent = 'æ­£åœ¨åˆ†æç« èŠ‚ç»“æ„...';

                // ç¡®ä¿å†…å®¹åŒºåŸŸå¯è§
                document.getElementById('content').style.display = 'block';

                // æ£€æµ‹ç« èŠ‚
                detectChapters(text);

                // æ·»åŠ åˆ°å†å²è®°å½•
                addToHistory({
                    fileName: currentFileName,
                    date: new Date().toLocaleString(),
                    lastPosition: currentPage,
                    chapter: currentChapter
                });
            };

            // å¼€å§‹è¯»å–ç¬¬ä¸€å—
            function readNextChunk() {
                let slice = file.slice(offset, offset + CHUNK_SIZE);
                fileReader.readAsArrayBuffer(slice);
            }

            // åˆå¹¶ ArrayBuffer æ•°ç»„
            function mergeArrayBuffers(buffers) {
                let totalLength = buffers.reduce((acc, buffer) => acc + buffer.byteLength, 0);
                let result = new Uint8Array(totalLength);
                let offset = 0;
                buffers.forEach(buffer => {
                    result.set(new Uint8Array(buffer), offset);
                    offset += buffer.byteLength;
                });
                return result.buffer;
            }

            // å¼€å§‹è¯»å–æ–‡ä»¶
            readNextChunk();
        });

        function detectChapters(text) {
            document.querySelector('.loading-message').textContent = 'æ­£åœ¨åˆ†æç« èŠ‚ç»“æ„...';

            // ä½¿ç”¨ Web Worker è¿›è¡Œç« èŠ‚æ£€æµ‹ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹
            const chapterWorker = createChapterWorker();

            chapterWorker.onmessage = function (e) {
                const result = e.data;

                if (result.error) {
                    console.error("ç« èŠ‚åˆ†æé”™è¯¯:", result.error);
                    document.getElementById('loading-overlay').style.display = 'none';
                    return;
                }

                chapters = result.chapters;

                if (result.noChapters) {
                    // å¦‚æœæ²¡æœ‰æ£€æµ‹åˆ°ç« èŠ‚ï¼Œå­˜å‚¨æ•´ä¸ªæ–‡æœ¬å†…å®¹
                    // æŒ‰ç…§å›ºå®šå­—æ•°(wordsPerPage)è€Œä¸æ˜¯æŒ‰è¡Œæ‹†åˆ†æ–‡æœ¬
                    const contentText = text;
                    currentContent = [];

                    // æ¯wordsPerPageä¸ªå­—ç¬¦åˆ†é¡µï¼Œè€Œä¸æ˜¯æŒ‰è¡Œ
                    for (let i = 0; i < contentText.length; i += wordsPerPage) {
                        currentContent.push(contentText.slice(i, i + wordsPerPage));
                    }

                    // ç¡®ä¿è‡³å°‘æœ‰ä¸€é¡µå†…å®¹
                    if (currentContent.length === 0 && contentText.length > 0) {
                        currentContent.push(contentText);
                    }

                    // è®¡ç®—æ€»é¡µæ•°
                    const totalPages = currentContent.length;

                    // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„è¿›åº¦
                    const allBookProgress = JSON.parse(localStorage.getItem('allBookProgress')) || {};
                    if (allBookProgress[currentFileName]) {
                        // æ¢å¤ä¿å­˜çš„é¡µç 
                        currentPage = allBookProgress[currentFileName].page || 0;
                        // ç¡®ä¿é¡µç æœ‰æ•ˆ
                        if (currentPage >= totalPages) {
                            currentPage = 0;
                        }
                    } else {
                        currentPage = 0;
                    }

                    // æ˜¾ç¤ºå†…å®¹
                    showTextPage(currentPage, totalPages);

                    // ç¡®ä¿æ§ä»¶å¯è§
                    document.querySelector('.navigation-buttons').style.display = 'flex';
                    document.querySelector('.progress-indicator').style.display = 'block';
                } else if (chapters.length > 0) {
                    updateChapterList();
                    // æ˜¾ç¤ºç¿»é¡µæŒ‰é’®
                    document.querySelector('.navigation-buttons').style.display = 'flex';
                    document.querySelector('.progress-indicator').style.display = 'block';

                    // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„è¿›åº¦ï¼Œä»å¤šä¹¦ç±è¿›åº¦å­˜å‚¨ä¸­è·å–
                    const allBookProgress = JSON.parse(localStorage.getItem('allBookProgress')) || {};
                    if (allBookProgress[currentFileName]) {
                        showPage(allBookProgress[currentFileName].page || 0, allBookProgress[currentFileName].chapter || 0);
                    } else {
                        jumpToChapter(0);
                    }
                }

                document.querySelector('.loading-message').textContent = 'åŠ è½½å®Œæˆ';
                document.getElementById('loading-overlay').style.display = 'none';

                // ä¿å­˜å½“å‰æ–‡ä»¶çš„è¿›åº¦
                saveProgress();

                // æ›´æ–°è¿›åº¦æ¡
                updateProgressBar();

                // åº”ç”¨å­˜å‚¨çš„å­—ä½“è®¾ç½®
                applyStoredSettings();
            };

            // å‘é€æ–‡æœ¬åˆ° Worker è¿›è¡Œå¤„ç†
            chapterWorker.postMessage({
                text: text,
                wordsPerPage: wordsPerPage
            });
        }

        // ä¿®æ”¹ createFileWorker å‡½æ•°ä»¥æ”¯æŒæ›´å¤šç¼–ç æ ¼å¼
        function createFileWorker() {
            const workerCode = `
                // å¼•å…¥å¤–éƒ¨çš„ GBK è§£ç åº“
                importScripts('https://cdn.jsdelivr.net/npm/gbk.js@0.3.0/dist/gbk.min.js');
                
                self.onmessage = function(e) {
                    const arrayBuffer = e.data.buffer;
                    const fileName = e.data.fileName;
                    let text = null;
                    let successEncoding = '';
                    
                    try {
                        // å°è¯•ä¸åŒçš„ç¼–ç  - ä¼˜å…ˆæ¬¡åºå¾ˆé‡è¦
                        const encodings = [
                            'utf-8', 
                            'gbk',    // ä¸­æ–‡ç®€ä½“
                            'big5',   // ä¸­æ–‡ç¹ä½“
                            'shift_jis', // æ—¥æ–‡
                            'euc-kr',    // éŸ©æ–‡
                            'windows-1252', // è¥¿æ¬§
                            'iso-8859-1',   // æ‹‰ä¸æ–‡1
                            'iso-8859-2',   // ä¸­æ¬§
                            'iso-8859-5',   // è¥¿é‡Œå°”æ–‡
                            'iso-8859-7',   // å¸Œè…Šæ–‡
                            'utf-16le',
                            'utf-16be',
                            'iso-8859-9',   // åœŸè€³å…¶è¯­
                            'windows-1256', // é˜¿æ‹‰ä¼¯è¯­
                            'windows-1251', // è¥¿é‡Œå°”æ–‡
                            'windows-1254', // åœŸè€³å…¶è¯­
                            'koi8-r',      // ä¿„è¯­
                            'euc-jp',      // æ—¥è¯­
                            'gb18030',     // ä¸­æ–‡æ‰©å±•
                            'hz-gb-2312',  // ä¸­æ–‡ç®€ä½“
                            'iso-2022-jp', // æ—¥è¯­
                            'iso-2022-kr', // éŸ©è¯­
                            'iso-8859-6',  // é˜¿æ‹‰ä¼¯è¯­
                            'iso-8859-8',  // å¸Œä¼¯æ¥è¯­
                            'windows-874', // æ³°è¯­
                            'windows-1255', // å¸Œä¼¯æ¥è¯­
                            'windows-1258'  // è¶Šå—è¯­
                        ];
                        
                        // å°è¯•è‡ªåŠ¨æ£€æµ‹BOMæ ‡è®°
                        const byteArray = new Uint8Array(arrayBuffer.slice(0, 4));
                        if (byteArray[0] === 0xEF && byteArray[1] === 0xBB && byteArray[2] === 0xBF) {
                            // UTF-8 with BOM
                            const decoder = new TextDecoder('utf-8');
                            text = decoder.decode(arrayBuffer);
                            successEncoding = 'utf-8 (BOM)';
                        } else if (byteArray[0] === 0xFE && byteArray[1] === 0xFF) {
                            // UTF-16 BE BOM
                            const decoder = new TextDecoder('utf-16be');
                            text = decoder.decode(arrayBuffer);
                            successEncoding = 'utf-16be (BOM)';
                        } else if (byteArray[0] === 0xFF && byteArray[1] === 0xFE) {
                            // UTF-16 LE BOM
                            const decoder = new TextDecoder('utf-16le');
                            text = decoder.decode(arrayBuffer);
                            successEncoding = 'utf-16le (BOM)';
                        } else if (byteArray[0] === 0x00 && byteArray[1] === 0x00 && byteArray[2] === 0xFE && byteArray[3] === 0xFF) {
                            // UTF-32 BE BOM
                            try {
                                const decoder = new TextDecoder('utf-32be');
                                text = decoder.decode(arrayBuffer);
                                successEncoding = 'utf-32be (BOM)';
                            } catch (err) {
                                // å¦‚æœæµè§ˆå™¨ä¸æ”¯æŒUTF-32ï¼Œå°è¯•å…¶ä»–ç¼–ç 
                            }
                        } else if (byteArray[0] === 0xFF && byteArray[1] === 0xFE && byteArray[2] === 0x00 && byteArray[3] === 0x00) {
                            // UTF-32 LE BOM
                            try {
                                const decoder = new TextDecoder('utf-32le');
                                text = decoder.decode(arrayBuffer);
                                successEncoding = 'utf-32le (BOM)';
                            } catch (err) {
                                // å¦‚æœæµè§ˆå™¨ä¸æ”¯æŒUTF-32ï¼Œå°è¯•å…¶ä»–ç¼–ç 
                            }
                        } else {
                            // æ²¡æœ‰BOMï¼Œå°è¯•å„ç§ç¼–ç 
                            for (let encoding of encodings) {
                                try {
                                    if (encoding === 'gbk' || encoding === 'gb18030' || encoding === 'hz-gb-2312') {
                                        // ä½¿ç”¨GBK.jsåº“å¤„ç†ä¸­æ–‡ç¼–ç 
                                        const gbkBytes = new Uint8Array(arrayBuffer);
                                        try {
                                            text = GBK.decode(gbkBytes);
                                            if (text && !containsUnreadableChars(text)) {
                                                successEncoding = encoding;
                                                break;
                                            }
                                        } catch (err) {
                                            // è§£ç å¤±è´¥ï¼Œç»§ç»­å°è¯•å…¶ä»–ç¼–ç 
                                            continue;
                                        }
                                    } else {
                                        const decoder = new TextDecoder(encoding);
                                        text = decoder.decode(arrayBuffer);
                                        
                                        // æ£€æŸ¥è§£ç ç»“æœæ˜¯å¦åŒ…å«å¤ªå¤šæ— æ³•è¯»å–çš„å­—ç¬¦
                                        if (text && !containsUnreadableChars(text)) {
                                            successEncoding = encoding;
                                            break;
                                        }
                                    }
                                } catch (error) {
                                    // å°è¯•ä¸‹ä¸€ä¸ªç¼–ç 
                                    continue;
                                }
                            }
                        }
                        
                        // å¦‚æœæ‰€æœ‰ç¼–ç éƒ½å¤±è´¥ï¼Œä½¿ç”¨ç³»ç»Ÿé»˜è®¤ç¼–ç 
                        if (!text) {
                            const defaultDecoder = new TextDecoder();
                            text = defaultDecoder.decode(arrayBuffer);
                            successEncoding = 'default';
                        }
                        
                        // æ£€æŸ¥æœ€ç»ˆè§£ç ç»“æœæ˜¯å¦æœ‰æ•ˆ
                        if (text && containsUnreadableChars(text)) {
                            // å¦‚æœåŒ…å«å¤ªå¤šæ— æ³•è¯»å–çš„å­—ç¬¦ï¼Œå°è¯•ä½¿ç”¨æ–‡ä»¶åæç¤ºçš„ç¼–ç å†æ¬¡è§£ç 
                            const fileName_lower = fileName.toLowerCase();
                            if (fileName_lower.includes('gbk') || 
                                fileName_lower.includes('gb2312') || 
                                fileName_lower.includes('gb18030')) {
                                // æ ¹æ®æ–‡ä»¶åæç¤ºå°è¯•GBK
                                const gbkBytes = new Uint8Array(arrayBuffer);
                                text = GBK.decode(gbkBytes);
                                successEncoding = 'gbk (filename hint)';
                            } else if (fileName_lower.includes('big5')) {
                                // æ ¹æ®æ–‡ä»¶åæç¤ºå°è¯•Big5
                                const decoder = new TextDecoder('big5');
                                text = decoder.decode(arrayBuffer);
                                successEncoding = 'big5 (filename hint)';
                            } else if (fileName_lower.includes('sjis') || fileName_lower.includes('shift-jis')) {
                                // æ ¹æ®æ–‡ä»¶åæç¤ºå°è¯•Shift-JIS
                                const decoder = new TextDecoder('shift-jis');
                                text = decoder.decode(arrayBuffer);
                                successEncoding = 'shift-jis (filename hint)';
                            } else if (fileName_lower.includes('euc-kr')) {
                                // æ ¹æ®æ–‡ä»¶åæç¤ºå°è¯•EUC-KR
                                const decoder = new TextDecoder('euc-kr');
                                text = decoder.decode(arrayBuffer);
                                successEncoding = 'euc-kr (filename hint)';
                            } else if (fileName_lower.includes('utf16') || fileName_lower.includes('utf-16')) {
                                // æ ¹æ®æ–‡ä»¶åæç¤ºå°è¯•UTF-16
                                try {
                                    const decoder = new TextDecoder('utf-16le');
                                    text = decoder.decode(arrayBuffer);
                                    successEncoding = 'utf-16le (filename hint)';
                                } catch (err) {
                                    try {
                                        const decoder = new TextDecoder('utf-16be');
                                        text = decoder.decode(arrayBuffer);
                                        successEncoding = 'utf-16be (filename hint)';
                                    } catch (err2) {
                                        // ä¸¤ç§UTF-16éƒ½å¤±è´¥äº†
                                    }
                                }
                            }
                        }
                        
                        // å‘é€è§£ç ç»“æœå’Œä½¿ç”¨çš„ç¼–ç ä¿¡æ¯
                        self.postMessage({ 
                            text: text, 
                            encoding: successEncoding 
                        });
                    } catch (error) {
                        self.postMessage({ error: error.message });
                    }
                };
                
                // æ£€æŸ¥æ–‡æœ¬ä¸­æ˜¯å¦åŒ…å«è¿‡å¤šæ— æ³•è¯»å–çš„å­—ç¬¦
                function containsUnreadableChars(text) {
                    // æ£€æŸ¥æ›¿æ¢å­—ç¬¦çš„æ¯”ä¾‹
                    const replacementChar = '\\uFFFD'; // Unicode æ›¿æ¢å­—ç¬¦
                    const replacementCount = (text.match(new RegExp(replacementChar, 'g')) || []).length;
                    
                    // æ£€æŸ¥é—®å·å­—ç¬¦çš„æ¯”ä¾‹ï¼ˆå¯èƒ½æ˜¯æ›¿æ¢å­—ç¬¦ï¼‰
                    const questionMarkCount = (text.match(/\\?/g) || []).length;
                    
                    // æ£€æŸ¥ä¹±ç å­—ç¬¦çš„æ¯”ä¾‹
                    const gibberishRegex = /[\\x00-\\x08\\x0E-\\x1F\\x7F-\\x9F\\uFFFD]/g;
                    const gibberishCount = (text.match(gibberishRegex) || []).length;
                    
                    // è®¡ç®—æ€»çš„å¯ç–‘å­—ç¬¦æ¯”ä¾‹
                    const suspiciousChars = replacementCount + questionMarkCount + gibberishCount;
                    const threshold = 0.1; // å¦‚æœè¶…è¿‡10%çš„å­—ç¬¦æ˜¯å¯ç–‘å­—ç¬¦ï¼Œè®¤ä¸ºç¼–ç å¯èƒ½ä¸æ­£ç¡®
                    
                    return suspiciousChars > text.length * threshold;
                }
            `;

            const blob = new Blob([workerCode], { type: 'application/javascript' });
            const url = URL.createObjectURL(blob);
            const worker = new Worker(url);

            // æ¸…ç† URL å¯¹è±¡
            URL.revokeObjectURL(url);

            return worker;
        }

        // åˆ›å»ºå¤„ç†ç« èŠ‚çš„ Web Worker
        function createChapterWorker() {
            const workerCode = `
                self.onmessage = function(e) {
                    const text = e.data.text;
                    const wordsPerPage = e.data.wordsPerPage;
                    
                    try {
                        const lines = text.split('\\n');
                        let chapters = [];
                        let position = 0;
                        let lastChapterStart = 0;
                        
                        // æ”¹è¿›ç« èŠ‚åŒ¹é…æ¨¡å¼ï¼Œæ”¯æŒæ›´å¤šæ ¼å¼
                        const chapterPatterns = [
                            /^ç¬¬[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒä¸‡0-9ï¼-ï¼™\\d]+[ç« èŠ‚å›é›†å·]/,  // æ ‡å‡†ç« èŠ‚æ ¼å¼
                            /^[ç¬¬]?[0-9ï¼-ï¼™]{1,4}[ç« èŠ‚å›é›†å·]/,  // æ•°å­—ç« èŠ‚
                            /^Chapter\\s+[0-9ï¼-ï¼™]+/i,  // è‹±æ–‡ç« èŠ‚
                            /^[ï¼ˆ(ã€ã€Œã€]?ç¬¬?[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒä¸‡0-9ï¼-ï¼™\\d]+[ç« èŠ‚å›é›†å·][)ï¼‰ã€‘ã€ã€]?/,  // å¸¦æ‹¬å·çš„ç« èŠ‚
                            /^(åºç« |åºå¹•|å‰è¨€|å¼•å­|æ¥”å­|å°¾å£°|åè®°|ç•ªå¤–|ç•ªå¤–ç¯‡|ç»ˆç« |å®Œæœ¬æ„Ÿè¨€|é™„å½•|é™„ä»¶)/  // ç‰¹æ®Šç« èŠ‚
                        ];
                        
                        // æ£€æŸ¥æ˜¯å¦æœ‰ç« èŠ‚
                        let hasChapters = false;
                        for (let i = 0; i < Math.min(2000, lines.length); i++) {
                            const line = lines[i].trim();
                            // ç« èŠ‚åé€šå¸¸æ¯”è¾ƒçŸ­ï¼Œå¿½ç•¥è¿‡é•¿çš„è¡Œä»¥æé«˜å‡†ç¡®æ€§
                            if (line.length > 0 && line.length < 50) {
                                for (const pattern of chapterPatterns) {
                                    if (pattern.test(line)) {
                                        hasChapters = true;
                                        break;
                                    }
                                }
                                if (hasChapters) break;
                            }
                        }
                        
                        if (!hasChapters) {
                            // å¦‚æœæ²¡æœ‰æ£€æµ‹åˆ°ç« èŠ‚ï¼Œé€šçŸ¥ä¸»çº¿ç¨‹
                            self.postMessage({
                                noChapters: true,
                                chapters: []
                            });
                            return;
                        }
                        
                        // å¦‚æœæœ‰ç« èŠ‚ï¼ŒæŒ‰ç« èŠ‚å¤„ç†
                        // æ£€æŸ¥ç¬¬ä¸€è¡Œæ˜¯å¦ä¸ºç« èŠ‚ï¼Œå¦‚æœä¸æ˜¯ï¼Œæ·»åŠ "å¼€å§‹"ä½œä¸ºç¬¬ä¸€ç« 
                        let firstChapterFound = false;
                        for (const pattern of chapterPatterns) {
                            if (pattern.test(lines[0].trim())) {
                                firstChapterFound = true;
                                break;
                            }
                        }
                        
                        if (!firstChapterFound) {
                            chapters.push({
                                title: 'å¼€å§‹',
                                position: 0,
                                content: ''
                            });
                        }
                        
                        lines.forEach((line, index) => {
                            let isChapter = false;
                            const trimmedLine = line.trim();
                            
                            // ç« èŠ‚åé€šå¸¸æ¯”è¾ƒçŸ­ï¼Œå¿½ç•¥è¿‡é•¿çš„è¡Œ
                            if (trimmedLine.length > 0 && trimmedLine.length < 50) {
                                for (const pattern of chapterPatterns) {
                                    if (pattern.test(trimmedLine)) {
                                        isChapter = true;
                                        break;
                                    }
                                }
                            }
                            
                            if (isChapter) {
                                if (chapters.length > 0) {
                                    chapters[chapters.length - 1].content = text.slice(lastChapterStart, position);
                                }
                                chapters.push({
                                    title: trimmedLine,
                                    position: position,
                                    content: ''
                                });
                                lastChapterStart = position;
                            }
                            position += line.length + 1;
                        });
                        
                        if (chapters.length > 0) {
                            chapters[chapters.length - 1].content = text.slice(lastChapterStart);
                            self.postMessage({
                                chapters: chapters,
                                noChapters: false
                            });
                        }
                    } catch (error) {
                        self.postMessage({ error: error.message });
                    }
                };
            `;

            const blob = new Blob([workerCode], { type: 'application/javascript' });
            const url = URL.createObjectURL(blob);
            const worker = new Worker(url);

            // æ¸…ç† URL å¯¹è±¡
            URL.revokeObjectURL(url);

            return worker;
        }

        // ä¿®å¤æ— ç« èŠ‚æ–‡ä»¶çš„åˆ†é¡µé—®é¢˜
        function showTextPage(pageNum, totalPages) {
            if (pageNum >= 0 && pageNum < totalPages) {
                currentPage = pageNum;

                const content = document.getElementById('content');
                // ç¡®ä¿å†…å®¹åŒºåŸŸå¯è§
                content.style.display = 'block';

                // è·å–å½“å‰é¡µå†…å®¹
                const pageText = currentContent[currentPage];

                // æŒ‰è¡Œæ‹†åˆ†å½“å‰é¡µå†…å®¹å¹¶æ˜¾ç¤º
                if (pageText) {
                    const lines = pageText.split('\n');
                    let htmlContent = '';
                    for (let line of lines) {
                        htmlContent += line.trim()
                            ? `<p>${line}</p>`
                            : '<p><br></p>';
                    }
                    content.innerHTML = htmlContent || '<p>æ­¤é¡µå†…å®¹ä¸ºç©º</p>';

                    // åº”ç”¨æ®µè½é—´è·è®¾ç½®
                    const settings = JSON.parse(localStorage.getItem('readerSettings') || '{}');
                    if (settings.paragraphSpacing) {
                        const paragraphs = document.querySelectorAll('#content p');
                        paragraphs.forEach(p => {
                            p.style.marginBottom = `${settings.paragraphSpacing}em`;
                        });
                    }
                } else {
                    // é¡µé¢å†…å®¹ä¸ºç©º
                    content.innerHTML = '<p>æ­¤é¡µæ— å†…å®¹</p>';
                    console.warn('å½“å‰é¡µå†…å®¹ä¸ºç©º: pageNum =', pageNum, 'totalPages =', totalPages);
                }

                // æ›´æ–°é¡µç æ˜¾ç¤ºï¼Œç¡®ä¿é¡µç æ­£ç¡®
                document.getElementById('page-info').textContent = `ç¬¬ ${currentPage + 1}/${totalPages} é¡µ`;

                // ä¿å­˜è¿›åº¦
                saveProgress();

                // æ»šåŠ¨åˆ°é¡µé¢é¡¶éƒ¨
                window.scrollTo(0, 0);
                content.scrollTop = 0;

                // ç¡®ä¿ç¿»é¡µæŒ‰é’®å¯è§
                document.querySelector('.navigation-buttons').style.display = 'flex';

                // æ›´æ–°è¿›åº¦æ¡
                updateProgressBar();
            } else {
                console.error('æ— æ•ˆçš„é¡µç :', pageNum, 'æ€»é¡µæ•°:', totalPages);
            }
        }

        function showPage(pageNum, chapterNum = currentChapter) {
            if (!chapters[chapterNum]) {
                console.error('æ— æ•ˆçš„ç« èŠ‚:', chapterNum);
                return;
            }

            const chapterContent = chapters[chapterNum].content;
            const totalPages = Math.ceil(chapterContent.length / wordsPerPage);

            if (pageNum >= 0 && pageNum < totalPages) {
                currentPage = pageNum;
                currentChapter = chapterNum;

                const start = currentPage * wordsPerPage;
                const end = start + wordsPerPage;
                const content = document.getElementById('content');
                content.innerHTML = chapterContent
                    .slice(start, end)
                    .split('\n')
                    .map(line => line.trim() ? `<p>${line}</p>` : '<p><br></p>')
                    .join('');

                // åº”ç”¨æ®µè½é—´è·è®¾ç½®
                const settings = JSON.parse(localStorage.getItem('readerSettings') || '{}');
                if (settings.paragraphSpacing) {
                    const paragraphs = document.querySelectorAll('#content p');
                    paragraphs.forEach(p => {
                        p.style.marginBottom = `${settings.paragraphSpacing}em`;
                    });
                }

                document.getElementById('page-info').textContent = `ç¬¬ ${currentPage + 1}/${totalPages} é¡µ`;

                // ä¿å­˜è¿›åº¦
                saveProgress();

                // æ»šåŠ¨åˆ°é¡µé¢é¡¶éƒ¨
                window.scrollTo(0, 0);
                content.scrollTop = 0;
            } else {
                console.error('æ— æ•ˆçš„é¡µç :', pageNum, 'æ€»é¡µæ•°:', totalPages);
            }
        }

        function nextPage() {
            // å¦‚æœæ²¡æœ‰ç« èŠ‚ï¼Œä½¿ç”¨æ•´ä½“åˆ†é¡µé€»è¾‘
            if (chapters.length === 0) {
                // ç¡®ä¿æ­£ç¡®è®¡ç®—æ€»é¡µæ•°
                const totalPages = currentContent.length;

                if (currentPage < totalPages - 1) {
                    showTextPage(currentPage + 1, totalPages);
                } else {
                    // å·²æ˜¯æœ€åä¸€é¡µï¼Œæ˜¾ç¤ºæç¤º
                    showNotification('å·²ç»æ˜¯æœ€åä¸€é¡µäº†');
                }
            } else {
                // æœ‰ç« èŠ‚çš„æƒ…å†µï¼Œä½¿ç”¨åŸæœ‰é€»è¾‘
                const currentChapterContent = chapters[currentChapter].content;
                const totalPagesInChapter = Math.ceil(currentChapterContent.length / wordsPerPage);

                if (currentPage < totalPagesInChapter - 1) {
                    showPage(currentPage + 1);
                } else if (currentChapter < chapters.length - 1) {
                    jumpToChapter(currentChapter + 1);
                } else {
                    // å·²æ˜¯æœ€åä¸€ç« æœ€åä¸€é¡µï¼Œæ˜¾ç¤ºæç¤º
                    showNotification('å·²ç»æ˜¯æœ€åä¸€é¡µäº†');
                }
            }
            saveProgress();
        }

        function previousPage() {
            // å¦‚æœæ²¡æœ‰ç« èŠ‚ï¼Œä½¿ç”¨æ•´ä½“åˆ†é¡µé€»è¾‘
            if (chapters.length === 0) {
                if (currentPage > 0) {
                    // ç¡®ä¿æ­£ç¡®è®¡ç®—æ€»é¡µæ•°
                    const totalPages = currentContent.length;
                    showTextPage(currentPage - 1, totalPages);
                } else {
                    // å·²æ˜¯ç¬¬ä¸€é¡µï¼Œæ˜¾ç¤ºæç¤º
                    showNotification('å·²ç»æ˜¯ç¬¬ä¸€é¡µäº†');
                }
            } else {
                // æœ‰ç« èŠ‚çš„æƒ…å†µï¼Œä½¿ç”¨åŸæœ‰é€»è¾‘
                if (currentPage > 0) {
                    showPage(currentPage - 1);
                } else if (currentChapter > 0) {
                    const prevChapterContent = chapters[currentChapter - 1].content;
                    const lastPage = Math.ceil(prevChapterContent.length / wordsPerPage) - 1;
                    showPage(lastPage, currentChapter - 1);
                } else {
                    // å·²æ˜¯ç¬¬ä¸€ç« ç¬¬ä¸€é¡µï¼Œæ˜¾ç¤ºæç¤º
                    showNotification('å·²ç»æ˜¯ç¬¬ä¸€é¡µäº†');
                }
            }
            saveProgress();
        }

        function toggleChapterList() {
            const chapterList = document.getElementById('chapter-list');
            if (chapterList.classList.contains('hidden')) {
                updateChapterList();
                chapterList.classList.remove('hidden');

                // æ·»åŠ é¼ æ ‡ç¦»å¼€äº‹ä»¶ç›‘å¬
                chapterList.addEventListener('mouseleave', function () {
                    chapterList.classList.add('hidden');
                });
            }
        }

        function jumpToChapter(index) {
            if (chapters[index]) {
                showPage(0, index);
                // ç¡®ä¿æ»šåŠ¨åˆ°é¡¶éƒ¨
                window.scrollTo(0, 0);
                document.getElementById('content').scrollTop = 0;
            }
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            // ä¿å­˜ä¸»é¢˜è®¾ç½®åˆ°é…ç½®æ–‡ä»¶
            ipcRenderer.invoke('save-config', {
                theme: document.body.classList.contains('dark-mode') ? 'dark' : 'light'
            });
        }

        function toggleFontSettings() {
            const panel = document.getElementById('font-settings-panel');
            panel.classList.toggle('hidden');
        }

        function changeFontFamily() {
            const fontFamily = document.getElementById('font-family-selector').value;
            document.getElementById('content').style.fontFamily = fontFamily;

            // ä¿å­˜åˆ°localStorage
            const settings = JSON.parse(localStorage.getItem('readerSettings') || '{}');
            settings.fontFamily = fontFamily;
            localStorage.setItem('readerSettings', JSON.stringify(settings));
        }

        function changeLineHeight() {
            const lineHeight = document.getElementById('line-height-slider').value;
            document.getElementById('line-height-value').textContent = lineHeight;
            document.getElementById('content').style.lineHeight = lineHeight;

            // ä¿å­˜åˆ°localStorage
            const settings = JSON.parse(localStorage.getItem('readerSettings') || '{}');
            settings.lineHeight = lineHeight;
            localStorage.setItem('readerSettings', JSON.stringify(settings));
        }

        function changeLetterSpacing() {
            const letterSpacing = document.getElementById('letter-spacing-slider').value;
            document.getElementById('letter-spacing-value').textContent = letterSpacing;
            document.getElementById('content').style.letterSpacing = `${letterSpacing}em`;

            // ä¿å­˜åˆ°localStorage
            const settings = JSON.parse(localStorage.getItem('readerSettings') || '{}');
            settings.letterSpacing = letterSpacing;
            localStorage.setItem('readerSettings', JSON.stringify(settings));
        }

        function changeParagraphSpacing() {
            const paragraphSpacing = document.getElementById('paragraph-spacing-slider').value;
            document.getElementById('paragraph-spacing-value').textContent = `${paragraphSpacing}em`;

            // åº”ç”¨æ ·å¼åˆ°æ‰€æœ‰æ®µè½
            const paragraphs = document.querySelectorAll('#content p');
            paragraphs.forEach(p => {
                p.style.marginBottom = `${paragraphSpacing}em`;
            });

            // ä¿å­˜åˆ°localStorage
            const settings = JSON.parse(localStorage.getItem('readerSettings') || '{}');
            settings.paragraphSpacing = paragraphSpacing;
            localStorage.setItem('readerSettings', JSON.stringify(settings));
        }

        function applyStoredSettings() {
            const settings = JSON.parse(localStorage.getItem('readerSettings') || '{}');

            if (settings.fontFamily) {
                document.getElementById('font-family-selector').value = settings.fontFamily;
                document.getElementById('content').style.fontFamily = settings.fontFamily;
            }

            if (settings.lineHeight) {
                document.getElementById('line-height-slider').value = settings.lineHeight;
                document.getElementById('line-height-value').textContent = settings.lineHeight;
                document.getElementById('content').style.lineHeight = settings.lineHeight;
            }

            if (settings.letterSpacing) {
                document.getElementById('letter-spacing-slider').value = settings.letterSpacing;
                document.getElementById('letter-spacing-value').textContent = settings.letterSpacing;
                document.getElementById('content').style.letterSpacing = `${settings.letterSpacing}em`;
            }

            if (settings.paragraphSpacing) {
                document.getElementById('paragraph-spacing-slider').value = settings.paragraphSpacing;
                document.getElementById('paragraph-spacing-value').textContent = `${settings.paragraphSpacing}em`;
            }

            // åˆ†åˆ«åº”ç”¨é˜…è¯»å†…å®¹å’Œä¸»é¡µå­—ä½“å¤§å°
            if (settings.fontSize) {
                fontSize = parseInt(settings.fontSize);
                // åªæœ‰åœ¨é˜…è¯»æ¨¡å¼ä¸‹æ‰åº”ç”¨å­—ä½“å¤§å°
                if (currentFileName) {
                    document.getElementById('content').style.fontSize = `${fontSize}px`;
                }
            }

            if (settings.homePageFontSize) {
                homePageFontSize = parseInt(settings.homePageFontSize);
                // åªæœ‰åœ¨ä¸»é¡µæ¨¡å¼ä¸‹æ‰åº”ç”¨ä¸»é¡µå­—ä½“å¤§å°
                if (!currentFileName) {
                    applyHomePageFontSize();
                }
            }
        }

        function applyHomePageFontSize() {
            // åº”ç”¨ä¸»é¡µå­—ä½“å¤§å°
            if (!currentFileName) {
                document.querySelectorAll('.history-list').forEach(el => {
                    el.style.fontSize = `${homePageFontSize}px`;
                });
                document.querySelectorAll('.history-title').forEach(el => {
                    el.style.fontSize = `${homePageFontSize + 2}px`;
                });
                document.querySelectorAll('.history-date, .history-progress').forEach(el => {
                    el.style.fontSize = `${homePageFontSize - 2}px`;
                });
            }
        }

        function changeFontSize(delta) {
            if (currentFileName) {
                // é˜…è¯»æ¨¡å¼ä¸‹ï¼Œè°ƒæ•´é˜…è¯»å­—ä½“å¤§å°
                fontSize += delta * 2;
                if (fontSize < 12) fontSize = 12;
                if (fontSize > 36) fontSize = 36;

                document.getElementById('content').style.fontSize = `${fontSize}px`;

                // ä¿å­˜åˆ°localStorage
                const settings = JSON.parse(localStorage.getItem('readerSettings') || '{}');
                settings.fontSize = fontSize;
                localStorage.setItem('readerSettings', JSON.stringify(settings));
            } else {
                // ä¸»é¡µæ¨¡å¼ä¸‹ï¼Œè°ƒæ•´ä¸»é¡µå­—ä½“å¤§å°
                homePageFontSize += delta * 2;
                if (homePageFontSize < 12) homePageFontSize = 12;
                if (homePageFontSize > 24) homePageFontSize = 24;

                applyHomePageFontSize();

                // ä¿å­˜åˆ°localStorage
                const settings = JSON.parse(localStorage.getItem('readerSettings') || '{}');
                settings.homePageFontSize = homePageFontSize;
                localStorage.setItem('readerSettings', JSON.stringify(settings));
            }
        }

        function setFontSize(size) {
            if (currentFileName) {
                // é˜…è¯»æ¨¡å¼ä¸‹è®¾ç½®å­—ä½“å¤§å°
                fontSize = size;
                document.getElementById('content').style.fontSize = `${fontSize}px`;

                // ä¿å­˜åˆ°localStorage
                const settings = JSON.parse(localStorage.getItem('readerSettings') || '{}');
                settings.fontSize = fontSize;
                localStorage.setItem('readerSettings', JSON.stringify(settings));
            } else {
                // ä¸»é¡µæ¨¡å¼ä¸‹è®¾ç½®å­—ä½“å¤§å°
                homePageFontSize = size;
                applyHomePageFontSize();

                // ä¿å­˜åˆ°localStorage
                const settings = JSON.parse(localStorage.getItem('readerSettings') || '{}');
                settings.homePageFontSize = homePageFontSize;
                localStorage.setItem('readerSettings', JSON.stringify(settings));
            }
        }

        // ä¿®æ”¹é”®ç›˜äº‹ä»¶å¤„ç†ï¼Œåˆ é™¤æ•°å­—é”®è°ƒèŠ‚å­—ä½“å¤§å°å’Œæ²‰æµ¸å¼é˜…è¯»æ¨¡å¼åˆ‡æ¢
        document.addEventListener('keydown', function (e) {
            // å·¦ç®­å¤´æˆ–PageUp - ä¸Šä¸€é¡µ
            if (e.key === 'ArrowLeft' || e.key === 'PageUp') {
                previousPage();
                e.preventDefault();
            }
            // å³ç®­å¤´æˆ–PageDownæˆ–ç©ºæ ¼ - ä¸‹ä¸€é¡µ
            else if (e.key === 'ArrowRight' || e.key === 'PageDown' || e.key === ' ') {
                nextPage();
                e.preventDefault();
            }
            // Homeé”® - è¿”å›é¦–é¡µ
            else if (e.key === 'Home') {
                backToHome();
                e.preventDefault();
            }
            // Té”® - åˆ‡æ¢ä¸»é¢˜
            else if (e.key === 't' || e.key === 'T') {
                toggleTheme();
                e.preventDefault();
            }
            // ESCé”® - è¿”å›ä¸»é¡µ
            else if (e.key === 'Escape') {
                backToHome();
                e.preventDefault();
            }
        });

        function updateChapterList() {
            const chapterList = document.getElementById('chapter-list');
            chapterList.innerHTML = chapters.map((chapter, index) =>
                `<div class="chapter-item ${index === currentChapter ? 'active' : ''}" 
                      onclick="jumpToChapter(${index})">${chapter.title}</div>`
            ).join('');
        }

        // ä¿®æ”¹ loadHistoryRecord å’Œ searchFile å‡½æ•°ï¼Œæ”¯æŒå¤šæœ¬ä¹¦çš„é˜…è¯»è¿›åº¦
        function loadHistoryRecord(fileName, lastPosition, lastChapter) {
            const pendingRestore = {
                fileName: fileName,
                position: lastPosition,
                chapter: lastChapter
            };
            localStorage.setItem('pendingRestore', JSON.stringify(pendingRestore));

            // ä¿å­˜è¿™äº›å€¼åˆ°å…¨å±€å˜é‡ï¼Œä»¥ä¾¿åœ¨ searchFile çš„å›è°ƒä¸­ä½¿ç”¨
            window.pendingPosition = lastPosition;
            window.pendingChapter = lastChapter;

            // æ˜¾ç¤ºåŠ è½½ä¸­
            document.getElementById('loading-overlay').style.display = 'flex';
            document.querySelector('.loading-message').textContent = `æ­£åœ¨æŸ¥æ‰¾æ–‡ä»¶: ${fileName}...`;

            // é€’å½’æœç´¢æ–‡ä»¶ï¼Œå…ˆåœ¨å½“å‰ç›®å½•æœç´¢ï¼Œç„¶ååœ¨å†å²æœç´¢ç›®å½•ä¸­æœç´¢
            // ç¡®ä¿ searchDirs å·²ç»åŒ…å«äº† baseDirï¼Œå¹¶ä¸”å»é‡
            const allPaths = [baseDir].concat(searchDirs);
            searchFile(allPaths, fileName);
        }

        // é€’å½’æœç´¢æ–‡ä»¶ï¼Œä½¿ç”¨ find-and-open-file-location çš„é€»è¾‘ï¼Œä½†åªè¿”å›è·¯å¾„
        async function searchFile(searchDirectories, fileName) {
            try {
                // å»é‡å¹¶è¿‡æ»¤ç©ºè·¯å¾„
                const uniqueDirs = [...new Set(searchDirectories)].filter(dir => dir);

                if (uniqueDirs.length === 0) {
                    throw new Error('æ²¡æœ‰å¯ç”¨çš„æœç´¢è·¯å¾„');
                }

                // ä½¿ç”¨ä¸»è¿›ç¨‹çš„ find-and-open-file-location é€»è¾‘æ¥æŸ¥æ‰¾æ–‡ä»¶
                // ä½†æˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ–°çš„ IPC æ¥å£åªè¿”å›è·¯å¾„è€Œä¸æ‰“å¼€æ–‡ä»¶å¤¹
                // è¿™é‡Œæˆ‘ä»¬å¤ç”¨ search-file æ¥å£ï¼Œä½†éœ€è¦ä¿®æ”¹å®ƒçš„è°ƒç”¨æ–¹å¼
                // æˆ–è€…æˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨å‰ç«¯å¾ªç¯è°ƒç”¨ï¼Œä½†ä¸ºäº†æ•ˆç‡ï¼Œæœ€å¥½åœ¨åç«¯åš

                // æ—¢ç„¶ç”¨æˆ·åé¦ˆé€Ÿåº¦æ…¢ï¼Œæˆ‘ä»¬å°è¯•å¹¶è¡Œæœç´¢æ‰€æœ‰è·¯å¾„
                // ä½†ä¸ºäº†ä¿è¯ä¼˜å…ˆçº§ï¼Œæˆ‘ä»¬è¿˜æ˜¯æŒ‰é¡ºåºæˆ–è€…åˆ†ç»„å¹¶è¡Œ

                // è¿™é‡Œæˆ‘ä»¬ä¿®æ”¹ç­–ç•¥ï¼šç›´æ¥è°ƒç”¨ä¸€ä¸ªæ–°çš„ IPC æ¥å£ï¼Œè®©ä¸»è¿›ç¨‹å»å¤„ç†ä¼˜å…ˆçº§å’Œå¹¶è¡Œ
                // æˆ‘ä»¬å…ˆç”¨ç°æœ‰çš„ search-file æ¥å£ï¼Œä½†è¦åœ¨å‰ç«¯æ§åˆ¶å¥½é€»è¾‘

                // å®é™…ä¸Šï¼Œä¹‹å‰çš„é€’å½’é€»è¾‘æ˜¯ä¸²è¡Œçš„ï¼Œç¡®å®æ…¢
                // æˆ‘ä»¬æ”¹ä¸ºå¹¶è¡Œæœç´¢ï¼Œä½†ä¿ç•™ä¼˜å…ˆçº§

                // åˆ›å»ºä¸€ä¸ª Promise æ•°ç»„ï¼Œæ¯ä¸ªç›®å½•ä¸€ä¸ªæœç´¢ä»»åŠ¡
                // ä½†ä¸ºäº†ä¼˜å…ˆçº§ï¼Œæˆ‘ä»¬ä¸èƒ½ç®€å•åœ° Promise.anyï¼Œå› ä¸ºé‚£ä¼šè¿”å›æœ€å¿«çš„ç»“æœè€Œä¸æ˜¯ä¼˜å…ˆçº§æœ€é«˜çš„ç»“æœ

                // æ›´å¥½çš„æ–¹æ³•æ˜¯ï¼šè®©ä¸»è¿›ç¨‹æä¾›ä¸€ä¸ª 'find-file-in-paths' æ¥å£
                // æ—¢ç„¶ä¸èƒ½æ”¹ä¸»è¿›ç¨‹æ¥å£ï¼ˆæˆ–è€…æ”¹èµ·æ¥éº»çƒ¦ï¼‰ï¼Œæˆ‘ä»¬åœ¨å‰ç«¯ä¼˜åŒ–

                // å°è¯•ä½¿ç”¨ find-and-open-file-location çš„é€»è¾‘å˜ä½“
                // ä½†è¿™é‡Œæˆ‘ä»¬ç›´æ¥ä¿®æ”¹ searchFile å‡½æ•°ï¼Œä¸å†é€’å½’ï¼Œè€Œæ˜¯ä½¿ç”¨å¾ªç¯ + await

                let foundPath = null;

                // ä¼˜å…ˆæœç´¢ searchDirs ä¸­çš„è·¯å¾„ï¼ˆæŒ‰é¡ºåºï¼‰
                // ä¸ºäº†æé«˜é€Ÿåº¦ï¼Œæˆ‘ä»¬å¯ä»¥åˆ†æ‰¹å¹¶è¡Œï¼Œæ¯”å¦‚æ¯3ä¸ªç›®å½•ä¸€ç»„
                const BATCH_SIZE = 3;

                for (let i = 0; i < uniqueDirs.length; i += BATCH_SIZE) {
                    const batch = uniqueDirs.slice(i, i + BATCH_SIZE);
                    const promises = batch.map(dir => ipcRenderer.invoke('search-file', dir, fileName));

                    const results = await Promise.all(promises);

                    // æ£€æŸ¥è¿™ä¸€æ‰¹æ¬¡æœ‰æ²¡æœ‰æ‰¾åˆ°
                    // æ³¨æ„ï¼šæˆ‘ä»¬è¦æŒ‰ batch ä¸­çš„é¡ºåºæ¥æ£€æŸ¥ç»“æœï¼Œä»¥ä¿æŒä¼˜å…ˆçº§
                    for (let j = 0; j < results.length; j++) {
                        if (results[j]) {
                            foundPath = results[j];
                            break;
                        }
                    }

                    if (foundPath) break;
                }

                if (foundPath) {
                    document.querySelector('.loading-message').textContent = `æ­£åœ¨åŠ è½½æ–‡ä»¶: ${fileName}...`;
                    const data = await ipcRenderer.invoke('read-file', foundPath);

                    // ä½¿ç”¨ processFileContent å¤„ç†å†…å®¹ï¼ˆåŒ…å«è‡ªåŠ¨ç¼–ç æ£€æµ‹ï¼‰
                    // æ³¨æ„ï¼šdata å¯èƒ½æ˜¯ Buffer æˆ– Uint8Array
                    let arrayBuffer;
                    if (data.buffer) {
                        arrayBuffer = data.buffer.slice(data.byteOffset, data.byteOffset + data.byteLength);
                    } else {
                        arrayBuffer = new Uint8Array(data).buffer;
                    }

                    processFileContent(arrayBuffer, fileName);

                    // æ¢å¤è¿›åº¦é€»è¾‘ç§»åˆ° processFileContent çš„å›è°ƒæˆ–åç»­å¤„ç†ä¸­
                    // ä½† processFileContent æ˜¯å¼‚æ­¥çš„ï¼ˆé€šè¿‡ Workerï¼‰ï¼Œæˆ‘ä»¬éœ€è¦ä¼ é€’æ¢å¤å‚æ•°
                    // è¿™é‡Œæˆ‘ä»¬é€šè¿‡å…¨å±€å˜é‡ä¼ é€’ï¼Œæˆ–è€…ä¿®æ”¹ processFileContent
                    // ç°æœ‰çš„ processFileContent å·²ç»ä¼šè¯»å– localStorageï¼Œä½†æˆ‘ä»¬éœ€è¦ä¼˜å…ˆä½¿ç”¨ pendingPosition

                    // ç”±äº processFileContent å†…éƒ¨ä½¿ç”¨äº† Worker ä¸”æ²¡æœ‰è¿”å› Promiseï¼Œ
                    // æˆ‘ä»¬ä¾èµ–å®ƒå†…éƒ¨çš„ onmessage æ¥å¤„ç†åç»­é€»è¾‘
                    // ç°æœ‰çš„ processFileContent é€»è¾‘ä¸­å·²ç»æœ‰ä» localStorage è¯»å–è¿›åº¦çš„ä»£ç 
                    // æˆ‘ä»¬éœ€è¦ç¡®ä¿å®ƒèƒ½ä½¿ç”¨ window.pendingPosition

                } else {
                    throw new Error(`æ‰¾ä¸åˆ°æ–‡ä»¶: ${fileName}`);
                }

            } catch (error) {
                console.error('æ–‡ä»¶è¯»å–é”™è¯¯:', error);
                showNotification(`${error.message}`);

                if (error.message.includes('æ‰¾ä¸åˆ°æ–‡ä»¶')) {
                    if (confirm(`${fileName} æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ˜¯å¦ä»å†å²è®°å½•ä¸­åˆ é™¤ï¼Ÿ`)) {
                        deleteHistoryRecord(fileName);
                    }
                }
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }

        // ä¿®æ”¹æ·»åŠ å†å²è®°å½•çš„å‡½æ•°ï¼Œä¿å­˜æ›´å¤šä¿¡æ¯ä»¥ä¾¿è®¡ç®—è¿›åº¦
        function addToHistory(record) {
            // éªŒè¯è®°å½•æœ‰æ•ˆæ€§
            if (!record || !record.fileName || record.fileName.trim() === '') {
                console.warn('å°è¯•æ·»åŠ æ— æ•ˆçš„å†å²è®°å½•:', record);
                return;
            }

            let history = JSON.parse(localStorage.getItem('readingHistory')) || [];

            // æ·»åŠ æ—¶é—´æˆ³
            record.timestamp = new Date().getTime();

            // æ·»åŠ ç« èŠ‚å’Œé¡µé¢æ€»æ•°ä¿¡æ¯ï¼Œç”¨äºè®¡ç®—è¿›åº¦
            if (chapters.length > 0) {
                record.totalChapters = chapters.length;
            } else if (currentContent) {
                record.totalPages = Math.ceil(currentContent.length / wordsPerPage);
            }

            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒæ–‡ä»¶åçš„è®°å½•
            const existingIndex = history.findIndex(item => item.fileName === record.fileName);
            if (existingIndex !== -1) {
                // ä¿ç•™åŸæ¥çš„recordå¯¹è±¡ï¼Œåªæ›´æ–°éœ€è¦å˜åŠ¨çš„å­—æ®µ
                const oldRecord = history[existingIndex];
                record = { ...oldRecord, ...record };
                // åˆ é™¤æ—§è®°å½•
                history.splice(existingIndex, 1);
            }

            // æ·»åŠ æ–°è®°å½•åˆ°æœ€å‰é¢
            history.unshift(record);

            // é™åˆ¶å†å²è®°å½•æ•°é‡ä¸º50æ¡
            if (history.length > 50) {
                history.pop();
            }

            localStorage.setItem('readingHistory', JSON.stringify(history));

            // å¦‚æœå½“å‰åœ¨ä¸»é¡µï¼Œåˆ™æ›´æ–°å†å²è®°å½•æ˜¾ç¤º
            if (!currentFileName) {
                updateHistoryDisplay();
            }

            // ä¹Ÿæ›´æ–°é˜…è¯»è¿›åº¦å­˜å‚¨
            let allBookProgress = JSON.parse(localStorage.getItem('allBookProgress')) || {};
            allBookProgress[record.fileName] = {
                page: record.lastPosition,
                chapter: record.chapter || 0,
                lastRead: new Date().toISOString(),
                hasChapters: chapters.length > 0,
                totalChapters: chapters.length > 0 ? chapters.length : 0,
                totalPages: chapters.length === 0 && currentContent ? Math.ceil(currentContent.length / wordsPerPage) : 0
            };
            localStorage.setItem('allBookProgress', JSON.stringify(allBookProgress));
        }

        // ä¿®æ”¹å†å²è®°å½•æ˜¾ç¤º
        function updateHistoryDisplay() {
            let history = JSON.parse(localStorage.getItem('readingHistory')) || [];

            // è¿‡æ»¤æ‰æ— æ•ˆçš„å†å²è®°å½•ï¼ˆæ²¡æœ‰æ–‡ä»¶åçš„è®°å½•ï¼‰
            const validHistory = history.filter(record => record && record.fileName && record.fileName.trim() !== '');

            // å¦‚æœå‘ç°æ— æ•ˆè®°å½•ï¼Œæ›´æ–° localStorage
            if (validHistory.length !== history.length) {
                history = validHistory;
                localStorage.setItem('readingHistory', JSON.stringify(history));
            }

            const content = document.getElementById('content');

            // å¦‚æœå½“å‰æ²¡æœ‰æ‰“å¼€çš„æ–‡ä»¶ï¼Œæ˜¾ç¤ºå†å²è®°å½•
            if (!currentFileName) {
                let historyHtml = '<div class="history-list">';
                historyHtml += '<div class="history-header">';
                historyHtml += '<h2>æœ€è¿‘é˜…è¯»</h2>';
                if (history.length > 0) {
                    historyHtml += '<button onclick="clearHistory()" class="clear-history-btn">æ¸…ç©ºå†å²</button>';
                }
                historyHtml += '</div>';

                if (history.length === 0) {
                    historyHtml += '<p class="no-history">æš‚æ— é˜…è¯»è®°å½•</p>';
                } else {
                    historyHtml += '<div class="history-items">';
                    history.forEach(record => {
                        // å†æ¬¡æ£€æŸ¥æ–‡ä»¶åï¼Œç¡®ä¿å®‰å…¨
                        if (!record.fileName) return;

                        // è·å–è¯¥ä¹¦ç±çš„æœ€æ–°è¿›åº¦ä¿¡æ¯
                        const allBookProgress = JSON.parse(localStorage.getItem('allBookProgress')) || {};
                        const bookProgress = allBookProgress[record.fileName] || {};
                        const lastReadDate = bookProgress.lastRead ? new Date(bookProgress.lastRead).toLocaleString() : record.date;

                        // è®¡ç®—é˜…è¯»è¿›åº¦ç™¾åˆ†æ¯”
                        let progressDisplay = '';
                        if (bookProgress.hasChapters) {
                            // å¦‚æœæœ‰ç« èŠ‚ï¼Œè·å–ç« èŠ‚æ•°é‡
                            let chapterCount = record.totalChapters || 0;
                            if (chapterCount > 0) {
                                progressDisplay = `è¯»åˆ°: ${(bookProgress.chapter + 1)}/${chapterCount} ç« `;
                            } else {
                                // å¦‚æœæ²¡æœ‰ç« èŠ‚æ•°é‡ä¿¡æ¯ï¼Œåªæ˜¾ç¤ºå½“å‰ç« èŠ‚
                                progressDisplay = `è¯»åˆ°: ç¬¬${bookProgress.chapter + 1}ç« `;
                            }
                        } else {
                            // å¦‚æœæ²¡æœ‰ç« èŠ‚ï¼Œå°è¯•ä½¿ç”¨é¡µç ç™¾åˆ†æ¯”
                            if (bookProgress.page !== undefined && record.totalPages) {
                                const percentage = Math.min(100, Math.round(((bookProgress.page + 1) / record.totalPages) * 100));
                                progressDisplay = `è¿›åº¦: ${percentage}%`;
                            } else if (bookProgress.page !== undefined) {
                                // å¦‚æœæ²¡æœ‰æ€»é¡µæ•°ä¿¡æ¯ï¼Œåªæ˜¾ç¤ºå½“å‰é¡µç 
                                progressDisplay = `è¯»åˆ°: ç¬¬${bookProgress.page + 1}é¡µ`;
                            }
                        }

                        historyHtml += `
                            <div class="history-item" 
                                data-filename="${record.fileName}"
                                onclick="loadHistoryRecord('${record.fileName}', ${record.lastPosition}, ${record.chapter || 0})"
                                oncontextmenu="showHistoryContextMenu(event, '${record.fileName}'); return false;">
                                <div class="history-info">
                                    <div class="history-title">${record.fileName}</div>
                                    <div class="history-date">æœ€åé˜…è¯»: ${lastReadDate}</div>
                                    <div class="history-progress">${progressDisplay}</div>
                                </div>
                                <div class="history-delete" onclick="event.stopPropagation(); deleteHistoryRecord('${record.fileName}');">
                                    Ã—
                                </div>
                            </div>
                        `;
                    });
                    historyHtml += '</div>';
                }

                historyHtml += '</div>';
                content.innerHTML = historyHtml;

                // åº”ç”¨ä¸»é¡µå­—ä½“å¤§å°
                applyHomePageFontSize();
            }
        }

        // æ·»åŠ åˆ é™¤å•ä¸ªå†å²è®°å½•çš„å‡½æ•°
        function deleteHistoryRecord(fileName) {
            let history = JSON.parse(localStorage.getItem('readingHistory')) || [];
            history = history.filter(record => record.fileName !== fileName);
            localStorage.setItem('readingHistory', JSON.stringify(history));

            // åŒæ—¶æ¸…é™¤é˜…è¯»è¿›åº¦
            let allBookProgress = JSON.parse(localStorage.getItem('allBookProgress')) || {};
            if (allBookProgress[fileName]) {
                delete allBookProgress[fileName];
                localStorage.setItem('allBookProgress', JSON.stringify(allBookProgress));
            }

            // æ›´æ–°æ˜¾ç¤º
            updateHistoryDisplay();
            showNotification(`å·²ä»å†å²è®°å½•ä¸­ç§»é™¤: ${fileName}`);
        }

        // æ·»åŠ å³é”®èœå•ç›¸å…³å‡½æ•°
        function showHistoryContextMenu(event, fileName) {
            event.preventDefault();

            // åˆ é™¤å·²å­˜åœ¨çš„å³é”®èœå•
            const existingMenu = document.getElementById('history-context-menu');
            if (existingMenu) {
                existingMenu.remove();
            }

            // åˆ›å»ºå³é”®èœå•
            const menu = document.createElement('div');
            menu.id = 'history-context-menu';
            menu.className = 'context-menu';
            menu.innerHTML = `
                <div class="context-menu-item" onclick="deleteHistoryRecord('${fileName}')">
                    åˆ é™¤è®°å½•
                </div>
                <div class="context-menu-item" onclick="openFileLocation('${fileName}')">
                    æ‰“å¼€æ–‡ä»¶æ‰€åœ¨ä½ç½®
                </div>
                <div class="context-menu-item" onclick="selectCustomPath()">
                    æ·»åŠ æœç´¢è·¯å¾„
                </div>
                <div class="context-menu-item" onclick="manageSearchPaths()">
                    ç®¡ç†æœç´¢è·¯å¾„
                </div>
            `;

            // è®¾ç½®èœå•ä½ç½®
            menu.style.left = event.pageX + 'px';
            menu.style.top = event.pageY + 'px';

            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(menu);

            // å­˜å‚¨å½“å‰é€‰ä¸­çš„æ–‡ä»¶åï¼Œç”¨äºé”®ç›˜å¿«æ·é”®åˆ é™¤
            window.currentSelectedFileName = fileName;

            // æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬ï¼ŒæŒ‰Dé”®å¿«é€Ÿåˆ é™¤
            function handleKeyDown(e) {
                if (e.key.toLowerCase() === 'd') {
                    deleteHistoryRecord(window.currentSelectedFileName);
                    menu.remove();
                    document.removeEventListener('keydown', handleKeyDown);
                }
            }
            document.addEventListener('keydown', handleKeyDown);

            // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­èœå•
            document.addEventListener('click', function closeMenu() {
                menu.remove();
                document.removeEventListener('click', closeMenu);
                document.removeEventListener('keydown', handleKeyDown);
                window.currentSelectedFileName = null;
            });
        }

        // æ·»åŠ ç®¡ç†æœç´¢è·¯å¾„çš„å‡½æ•°
        function manageSearchPaths() {
            // åˆ›å»ºä¸€ä¸ªæ¨¡æ€å¯¹è¯æ¡†
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>ç®¡ç†æœç´¢è·¯å¾„ (å¯æ‹–æ‹½æ’åº)</h3>
                        <span class="modal-close">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="search-paths-list" id="search-paths-list">
                            ${searchDirs.map((dir, index) => {
                const isBaseDir = dir === baseDir;
                return `<div class="search-path-item ${isBaseDir ? 'active-base-dir' : ''}" draggable="true" data-index="${index}">
                                    <span class="drag-handle">â˜°</span>
                                    <div class="path-info">
                                        <span class="search-path-text" title="${dir}">${dir}</span>
                                        ${isBaseDir ? '<span class="base-dir-tag">å½“å‰éšæœºæº</span>' : ''}
                                    </div>
                                    <div class="path-actions">
                                        ${!isBaseDir ? `<button class="set-base-btn" data-index="${index}" title="è®¾ä¸ºéšæœºé˜…è¯»è·¯å¾„">è®¾ä¸ºéšæœºæº</button>` : ''}
                                        <span class="search-path-delete" data-index="${index}">Ã—</span>
                                    </div>
                                </div>`;
            }).join('')}
                        </div>
                        <div class="search-path-actions">
                            <button id="add-search-path">æ·»åŠ è·¯å¾„</button>
                        </div>
                    </div>
                </div>
            `;

            // æ·»åŠ æ ·å¼
            const style = document.createElement('style');
            style.textContent = `
                .search-path-item { cursor: move; user-select: none; display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
                .search-path-item.active-base-dir { background-color: #f0f9ff; border-left: 4px solid #2196F3; }
                .dark-mode .search-path-item.active-base-dir { background-color: #2c3e50; border-left: 4px solid #3498db; }
                .search-path-item.dragging { opacity: 0.5; background: #e0e0e0; }
                .drag-handle { margin-right: 10px; cursor: grab; color: #888; font-size: 18px; }
                .path-info { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
                .search-path-text { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
                .base-dir-tag { font-size: 12px; color: #2196F3; margin-top: 2px; font-weight: bold; }
                .path-actions { display: flex; align-items: center; gap: 10px; }
                .set-base-btn { padding: 2px 8px; font-size: 12px; background: #e0e0e0; border: none; border-radius: 4px; cursor: pointer; }
                .set-base-btn:hover { background: #d0d0d0; }
                .search-path-delete { color: #e74c3c; font-size: 20px; cursor: pointer; padding: 0 5px; }
            `;
            modal.appendChild(style);

            document.body.appendChild(modal);

            // ç»‘å®šè®¾ä¸ºéšæœºæºæŒ‰é’®äº‹ä»¶
            modal.querySelectorAll('.set-base-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const index = parseInt(e.target.dataset.index);
                    if (index >= 0 && index < searchDirs.length) {
                        baseDir = searchDirs[index];

                        // ä¿å­˜é…ç½®
                        await ipcRenderer.invoke('save-config', {
                            baseDir: baseDir,
                            searchDirs: searchDirs
                        });

                        showNotification(`å·²å°†éšæœºé˜…è¯»è·¯å¾„è®¾ç½®ä¸º: ${baseDir}`);

                        // åˆ·æ–°åˆ—è¡¨
                        document.body.removeChild(modal);
                        manageSearchPaths();
                    }
                });
            });

            // æ‹–æ‹½é€»è¾‘
            const list = modal.querySelector('#search-paths-list');
            let draggedItem = null;

            list.addEventListener('dragstart', (e) => {
                draggedItem = e.target.closest('.search-path-item');
                if (draggedItem) {
                    draggedItem.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', draggedItem.dataset.index);
                }
            });

            list.addEventListener('dragend', () => {
                if (draggedItem) {
                    draggedItem.classList.remove('dragging');
                    draggedItem = null;

                    // é‡æ–°æ„å»ºæ•°ç»„
                    const newSearchDirs = [];
                    list.querySelectorAll('.search-path-item .search-path-text').forEach(span => {
                        newSearchDirs.push(span.title || span.textContent);
                    });

                    // æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
                    if (JSON.stringify(searchDirs) !== JSON.stringify(newSearchDirs)) {
                        searchDirs = newSearchDirs;
                        // ä¿å­˜é…ç½®
                        ipcRenderer.invoke('save-config', {
                            searchDirs: searchDirs
                        }).then(() => {
                            // é‡æ–°æ¸²æŸ“åˆ—è¡¨ä»¥æ›´æ–°ç´¢å¼•
                            document.body.removeChild(modal);
                            manageSearchPaths();
                        });
                    }
                }
            });

            list.addEventListener('dragover', (e) => {
                e.preventDefault();
                const afterElement = getDragAfterElement(list, e.clientY);
                const draggable = document.querySelector('.dragging');
                if (draggable) {
                    if (afterElement == null) {
                        list.appendChild(draggable);
                    } else {
                        list.insertBefore(draggable, afterElement);
                    }
                }
            });

            function getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('.search-path-item:not(.dragging)')];

                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }

            // å…³é—­æŒ‰é’®äº‹ä»¶
            modal.querySelector('.modal-close').addEventListener('click', () => {
                document.body.removeChild(modal);
            });

            // åˆ é™¤è·¯å¾„äº‹ä»¶
            modal.querySelectorAll('.search-path-delete').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    // é‡æ–°è·å–å½“å‰DOMä¸­çš„ç´¢å¼•ï¼Œå› ä¸ºæ‹–æ‹½å¯èƒ½æ”¹å˜äº†é¡ºåº
                    const item = e.target.closest('.search-path-item');
                    const allItems = Array.from(list.querySelectorAll('.search-path-item'));
                    const index = allItems.indexOf(item);

                    if (index >= 0 && index < searchDirs.length) {
                        // å¦‚æœæ˜¯å½“å‰éšæœºé˜…è¯»è·¯å¾„ï¼Œä¸å…è®¸åˆ é™¤
                        if (searchDirs[index] === baseDir) {
                            showNotification('ä¸èƒ½åˆ é™¤å½“å‰éšæœºé˜…è¯»è·¯å¾„ï¼Œè¯·å…ˆå°†å…¶ä»–è·¯å¾„è®¾ä¸ºéšæœºæº');
                            return;
                        } searchDirs.splice(index, 1);

                        // ä¿å­˜é…ç½®
                        await ipcRenderer.invoke('save-config', {
                            searchDirs: searchDirs
                        });

                        // åˆ·æ–°åˆ—è¡¨
                        manageSearchPaths();
                        document.body.removeChild(modal);
                    }
                });
            });

            // æ·»åŠ è·¯å¾„äº‹ä»¶
            modal.querySelector('#add-search-path').addEventListener('click', async () => {
                const newPath = await selectCustomPath();
                if (newPath) {
                    document.body.removeChild(modal);
                    manageSearchPaths();
                }
            });
        }

        // é€‰æ‹©è‡ªå®šä¹‰è·¯å¾„å‡½æ•° - ä»…é€‰æ‹©è·¯å¾„ï¼Œä¸åŠ è½½ä¹¦ç±
        async function selectCustomPath() {
            try {
                let newPath;
                if (isWebMode) {
                    newPath = await showRemotePathSelector();
                } else {
                    newPath = await ipcRenderer.invoke('select-directory');
                }

                if (newPath) {
                    // ä¿å­˜æ–°è·¯å¾„ä½œä¸ºé»˜è®¤è·¯å¾„
                    baseDir = newPath;

                    // æ·»åŠ åˆ°æœç´¢è·¯å¾„åˆ—è¡¨
                    if (!searchDirs.includes(newPath)) {
                        searchDirs.push(newPath);
                    }

                    // ä¿å­˜é…ç½®
                    await ipcRenderer.invoke('save-config', {
                        baseDir: baseDir,
                        searchDirs: searchDirs
                    });

                    showNotification(`å·²å°†éšæœºé˜…è¯»è·¯å¾„è®¾ç½®ä¸º: ${baseDir}`);
                    return newPath;
                }
            } catch (error) {
                console.error('é€‰æ‹©è‡ªå®šä¹‰è·¯å¾„å¤±è´¥:', error);
                if (error !== 'cancelled') {
                    showNotification('é€‰æ‹©è·¯å¾„å¤±è´¥: ' + error.message);
                }
            }
            return null;
        }
        baseDir: newPath,
            searchDirs: searchDirs
                    });

        showNotification(`å·²è®¾ç½®æ–°è·¯å¾„: ${newPath}`);
                }
        return newPath;
            } catch (error) {
            console.error('é€‰æ‹©è·¯å¾„å¤±è´¥:', error);
            alert('é€‰æ‹©è·¯å¾„å¤±è´¥: ' + error.message);
            return null;
        }
        }

        // æ›´æ–°è¿›åº¦æ¡
        function updateProgressBar() {
            let percentage = 0;

            if (chapters.length === 0) {
                // å¦‚æœæ²¡æœ‰ç« èŠ‚ï¼Œä½¿ç”¨é¡µç è®¡ç®—è¿›åº¦
                const totalPages = currentContent.length;
                if (totalPages > 1) {
                    percentage = (currentPage / (totalPages - 1)) * 100;
                } else {
                    percentage = 100; // åªæœ‰ä¸€é¡µåˆ™æ˜¾ç¤º100%
                }

                // æ£€æŸ¥è¿›åº¦æ˜¯å¦è®¡ç®—æ­£ç¡®
                if (isNaN(percentage) || percentage < 0) {
                    console.warn('è¿›åº¦è®¡ç®—å‡ºé”™:', currentPage, totalPages);
                    percentage = 0;
                }
            } else {
                // å¦‚æœæœ‰ç« èŠ‚ï¼Œè®¡ç®—æ•´ä½“è¿›åº¦
                let totalCharsRead = 0;
                let totalChars = 0;

                // è®¡ç®—æ‰€æœ‰å·²è¯»ç« èŠ‚çš„å­—ç¬¦æ•°
                for (let i = 0; i < currentChapter; i++) {
                    totalCharsRead += chapters[i].content.length;
                }

                // åŠ ä¸Šå½“å‰ç« èŠ‚å·²è¯»çš„å­—ç¬¦æ•°
                if (chapters[currentChapter]) {
                    totalCharsRead += Math.min(
                        currentPage * wordsPerPage,
                        chapters[currentChapter].content.length
                    );
                }

                // è®¡ç®—æ‰€æœ‰ç« èŠ‚çš„æ€»å­—ç¬¦æ•°
                for (let i = 0; i < chapters.length; i++) {
                    totalChars += chapters[i].content.length;
                }

                // è®¡ç®—ç™¾åˆ†æ¯”
                if (totalChars > 0) {
                    percentage = (totalCharsRead / totalChars) * 100;
                }
            }

            // æ›´æ–°è¿›åº¦æ¡å’Œæ–‡æœ¬
            document.getElementById('progress-bar').style.width = `${Math.min(percentage, 100)}%`;
            document.getElementById('progress-percentage').textContent = `${Math.min(Math.round(percentage), 100)}%`;

            // æ›´æ–°æ ‡é¢˜æ˜¾ç¤ºå½“å‰ç« èŠ‚æˆ–é¡µç 
            if (chapters.length > 0 && chapters[currentChapter]) {
                const chapterTitle = chapters[currentChapter].title;
                document.getElementById('book-title').textContent =
                    `${currentFileName.replace('.txt', '')} - ${chapterTitle}`;
            } else if (currentContent && currentContent.length > 0) {
                // æ— ç« èŠ‚æ—¶æ˜¾ç¤ºé¡µç 
                document.getElementById('book-title').textContent =
                    `${currentFileName.replace('.txt', '')} - ç¬¬${currentPage + 1}/${currentContent.length}é¡µ`;
            }
        }

        // ä¿®æ”¹showPageå‡½æ•°ä»¥æ›´æ–°è¿›åº¦æ¡
        const originalShowPage = showPage;
        showPage = function (pageNum, chapterIndex) {
            originalShowPage(pageNum, chapterIndex);
            updateProgressBar();
        }

        // ä¿®æ”¹showTextPageå‡½æ•°ä»¥æ›´æ–°è¿›åº¦æ¡
        const originalShowTextPage = showTextPage;
        showTextPage = function (pageNum, totalPages) {
            originalShowTextPage(pageNum, totalPages);
            updateProgressBar();
        }

        // ä¿®å¤æ»šåŠ¨æ¨¡å¼åˆ‡æ¢å’Œæ˜¾ç¤º
        // é¡µé¢æ»šåŠ¨æ¨¡å¼
        let pageMode = 'page'; // é»˜è®¤åˆ†é¡µæ¨¡å¼

        document.getElementById('page-turn-mode').addEventListener('change', function (e) {
            pageMode = e.target.value;
            const content = document.getElementById('content');

            if (pageMode === 'scroll') {
                // åˆ‡æ¢åˆ°æ»šåŠ¨æ¨¡å¼
                content.style.overflowY = 'auto';
                content.style.maxHeight = '800px';
                content.classList.add('scroll-mode');

                // æ˜¾ç¤ºæ‰€æœ‰å†…å®¹
                showAllContent();
            } else {
                // åˆ‡æ¢å›åˆ†é¡µæ¨¡å¼
                content.style.overflowY = 'hidden';
                content.style.maxHeight = 'none';
                content.classList.remove('scroll-mode');

                if (chapters.length > 0) {
                    // æœ‰ç« èŠ‚æ—¶ï¼Œæ˜¾ç¤ºå½“å‰ç« èŠ‚
                    showPage(currentPage, currentChapter);
                } else {
                    // æ— ç« èŠ‚æ—¶ï¼Œæ˜¾ç¤ºå½“å‰é¡µ
                    const totalPages = currentContent.length;
                    showTextPage(currentPage, totalPages);
                }
            }
        });

        // ä¿®å¤æ˜¾ç¤ºæ‰€æœ‰å†…å®¹çš„å‡½æ•°
        function showAllContent() {
            const content = document.getElementById('content');
            // ç¡®ä¿å†…å®¹åŒºåŸŸå¯è§
            content.style.display = 'block';
            content.innerHTML = '';

            if (chapters.length > 0) {
                // æœ‰ç« èŠ‚çš„æƒ…å†µ
                for (let i = 0; i < chapters.length; i++) {
                    const chapter = chapters[i];

                    // æ·»åŠ ç« èŠ‚æ ‡é¢˜
                    const titleElement = document.createElement('h3');
                    titleElement.className = 'chapter-title';
                    titleElement.textContent = chapter.title;
                    content.appendChild(titleElement);

                    // æ·»åŠ ç« èŠ‚å†…å®¹
                    const lines = chapter.content.split('\n');
                    for (let line of lines) {
                        if (line.trim()) {
                            const p = document.createElement('p');
                            p.textContent = line;
                            content.appendChild(p);
                        } else {
                            content.innerHTML += '<p><br></p>';
                        }
                    }
                }
            } else if (currentContent && currentContent.length > 0) {
                // æ— ç« èŠ‚çš„æƒ…å†µï¼Œæ˜¾ç¤ºæ‰€æœ‰åˆ†é¡µå†…å®¹
                for (let i = 0; i < currentContent.length; i++) {
                    // æ·»åŠ é¡µç æ ‡è®°
                    const pageTitle = document.createElement('div');
                    pageTitle.className = 'page-marker';
                    pageTitle.textContent = `ç¬¬ ${i + 1} é¡µ`;
                    content.appendChild(pageTitle);

                    // æ·»åŠ é¡µé¢å†…å®¹
                    const pageText = currentContent[i];
                    if (pageText) {
                        const lines = pageText.split('\n');
                        for (let line of lines) {
                            if (line.trim()) {
                                const p = document.createElement('p');
                                p.textContent = line;
                                content.appendChild(p);
                            } else {
                                content.innerHTML += '<p><br></p>';
                            }
                        }
                    } else {
                        const p = document.createElement('p');
                        p.textContent = 'æ­¤é¡µæ— å†…å®¹';
                        content.appendChild(p);
                    }
                }
            } else {
                // æ²¡æœ‰å†…å®¹
                content.innerHTML = '<p>æ²¡æœ‰å¯æ˜¾ç¤ºçš„å†…å®¹</p>';
            }

            // æ»šåŠ¨åˆ°å½“å‰é˜…è¯»ä½ç½®
            scrollToCurrentPosition();
        }

        // æ»šåŠ¨åˆ°å½“å‰é˜…è¯»ä½ç½®
        function scrollToCurrentPosition() {
            const content = document.getElementById('content');

            if (chapters.length === 0) {
                // æ²¡æœ‰ç« èŠ‚æ—¶ï¼Œæ ¹æ®é¡µç è®¡ç®—æ»šåŠ¨ä½ç½®
                const scrollPercentage = currentPage / Math.ceil(currentContent.length / wordsPerPage);
                content.scrollTop = content.scrollHeight * scrollPercentage;
            } else if (chapters[currentChapter]) {
                // æœ‰ç« èŠ‚æ—¶ï¼ŒæŸ¥æ‰¾å½“å‰ç« èŠ‚æ ‡é¢˜å¹¶æ»šåŠ¨åˆ°è¯¥ä½ç½®
                const chapterTitles = content.querySelectorAll('.chapter-title');

                if (chapterTitles.length > currentChapter) {
                    chapterTitles[currentChapter].scrollIntoView();

                    // è®¡ç®—ç« èŠ‚å†…éƒ¨æ»šåŠ¨ä½ç½®
                    if (currentPage > 0) {
                        const chapterContent = chapters[currentChapter].content;
                        const totalPages = Math.ceil(chapterContent.length / wordsPerPage);
                        const scrollOffset = (currentPage / totalPages) *
                            (chapters[currentChapter].content.length / wordsPerPage) * 24; // ä¼°è®¡æ¯è¡Œé«˜åº¦24px

                        content.scrollTop += scrollOffset;
                    }
                }
            }
        }

        // è‡ªå®šä¹‰å³é”®èœå•
        const contextMenu = document.getElementById('context-menu');
        const content = document.getElementById('content');

        // é˜»æ­¢é»˜è®¤å³é”®èœå•
        content.addEventListener('contextmenu', function (e) {
            e.preventDefault();

            // è·å–é€‰ä¸­çš„æ–‡æœ¬
            const selectedText = window.getSelection().toString().trim();
            if (!selectedText) return;

            // æ˜¾ç¤ºè‡ªå®šä¹‰èœå•
            contextMenu.style.display = 'block';
            contextMenu.style.left = `${e.pageX}px`;
            contextMenu.style.top = `${e.pageY}px`;

            // å­˜å‚¨é€‰ä¸­çš„æ–‡æœ¬
            contextMenu.dataset.selectedText = selectedText;
        });

        // ç‚¹å‡»é¡µé¢å…¶ä»–åŒºåŸŸæ—¶éšè—èœå•
        document.addEventListener('click', function () {
            contextMenu.style.display = 'none';
        });

        // å¤åˆ¶é€‰ä¸­æ–‡æœ¬
        document.getElementById('menu-copy').addEventListener('click', function () {
            const selectedText = contextMenu.dataset.selectedText;
            if (selectedText) {
                navigator.clipboard.writeText(selectedText)
                    .then(() => {
                        showNotification('æ–‡æœ¬å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                    })
                    .catch(err => {
                        console.error('å¤åˆ¶å¤±è´¥: ', err);
                    });
            }
        });

        // æœç´¢é€‰ä¸­æ–‡æœ¬
        document.getElementById('menu-search').addEventListener('click', function () {
            const selectedText = contextMenu.dataset.selectedText;
            if (selectedText) {
                window.open(`https://www.baidu.com/s?wd=${encodeURIComponent(selectedText)}`, '_blank');
            }
        });

        // ç¿»è¯‘é€‰ä¸­æ–‡æœ¬
        document.getElementById('menu-translate').addEventListener('click', function () {
            const selectedText = contextMenu.dataset.selectedText;
            if (selectedText) {
                window.open(`https://fanyi.baidu.com/#zh/en/${encodeURIComponent(selectedText)}`, '_blank');
            }
        });

        // æœ—è¯»é€‰ä¸­æ–‡æœ¬
        document.getElementById('menu-tts').addEventListener('click', function () {
            const selectedText = contextMenu.dataset.selectedText;
            if (selectedText && 'speechSynthesis' in window) {
                const speech = new SpeechSynthesisUtterance(selectedText);
                speech.lang = 'zh-CN';
                window.speechSynthesis.speak(speech);
            } else {
                showNotification('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆ');
            }
        });

        // é€šçŸ¥æç¤º
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);

            // 2ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                notification.classList.add('fadeout');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 500);
            }, 2000);
        }

        // æ·»åŠ æ¸…ç©ºå†å²è®°å½•çš„å‡½æ•°
        function clearHistory() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰é˜…è¯»å†å²å—ï¼Ÿ')) {
                localStorage.removeItem('readingHistory');

                // æ¸…ç©ºæ‰€æœ‰ä¹¦ç±çš„é˜…è¯»è¿›åº¦
                localStorage.removeItem('allBookProgress');

                // æ›´æ–°ç•Œé¢
                updateHistoryDisplay();
                showNotification('å·²æ¸…ç©ºæ‰€æœ‰é˜…è¯»å†å²');
            }
        }

        // åˆå§‹åŒ–å‡½æ•°
        function initApp() {
            console.log('App initializing...');

            // ç»‘å®šäº‹ä»¶ç›‘å¬
            const randomButton = document.getElementById('random-book-btn');
            if (randomButton) {
                // ä½¿ç”¨ onclick å±æ€§ä»¥ç¡®ä¿è¦†ç›–æ—§çš„äº‹ä»¶å¤„ç†ï¼Œé¿å…é‡å¤ç»‘å®š
                randomButton.onclick = function (e) {
                    console.log('Random button clicked');
                    // æ£€æŸ¥æ˜¯å¦æŒ‰ä½äº†Ctrlé”®
                    const useCustomPath = e.ctrlKey;
                    loadRandomBook(useCustomPath);
                };

                // å³é”®èœå•
                randomButton.oncontextmenu = function (e) {
                    e.preventDefault();
                    // ç§»é™¤å·²å­˜åœ¨çš„èœå•
                    const existingMenu = document.getElementById('random-context-menu');
                    if (existingMenu) existingMenu.remove();

                    // åˆ›å»ºå³é”®èœå•
                    const menu = document.createElement('div');
                    menu.className = 'context-menu';
                    menu.id = 'random-context-menu';
                    menu.innerHTML = `
                        <div class="context-menu-item" onclick="resetRandomState()">
                            é‡ç½®éšæœºçŠ¶æ€
                        </div>
                        <div class="context-menu-item" onclick="selectCustomPath()">
                            é€‰æ‹©éšæœºç›®å½•
                        </div>
                    `;

                    // è®¾ç½®èœå•ä½ç½®
                    menu.style.left = e.pageX + 'px';
                    menu.style.top = e.pageY + 'px';

                    // æ·»åŠ åˆ°é¡µé¢
                    document.body.appendChild(menu);

                    // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­èœå•
                    function closeMenu() {
                        if (menu && menu.parentNode) {
                            menu.parentNode.removeChild(menu);
                        }
                        document.removeEventListener('click', closeMenu);
                    }
                    // å»¶è¿Ÿç»‘å®šå…³é—­äº‹ä»¶ï¼Œé˜²æ­¢ç«‹å³è§¦å‘
                    setTimeout(() => document.addEventListener('click', closeMenu), 0);
                };
            } else {
                console.error('Random button not found');
            }

            const libraryButton = document.getElementById('library-btn');
            if (libraryButton) {
                libraryButton.onclick = async function (e) {
                    console.log('Library button clicked');
                    if (e.ctrlKey) {
                        // æŒ‰ä½ Ctrl é”®ï¼Œè®¾ç½®ä¹¦åº“è·¯å¾„
                        await setLibraryPath();
                    } else {
                        // æ™®é€šç‚¹å‡»ï¼Œæ˜¾ç¤ºä¹¦åº“
                        showServerLibrary();
                    }
                };
            } else {
                console.error('Library button not found');
            }

            // åº”ç”¨å­˜å‚¨çš„å­—ä½“è®¾ç½®
            applyStoredSettings();
            // æ›´æ–°å†å²è®°å½•æ˜¾ç¤º
            updateHistoryDisplay();

            // åŠ è½½é…ç½®
            loadConfig().catch(err => console.error('é…ç½®åŠ è½½å¤±è´¥:', err));
        }

        // å°è¯•ç«‹å³åˆå§‹åŒ–ï¼ˆå¦‚æœè„šæœ¬åœ¨bodyåº•éƒ¨ï¼‰
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }        // è®¾ç½®ä¹¦åº“è·¯å¾„
        async function setLibraryPath() {
            try {
                let newPath;

                if (isWebMode) {
                    // Web æ¨¡å¼ä¸‹ï¼Œä½¿ç”¨è‡ªå®šä¹‰çš„è¿œç¨‹ç›®å½•é€‰æ‹©å™¨
                    newPath = await showRemotePathSelector();
                } else {
                    // Electron æ¨¡å¼ä¸‹ï¼Œæ‰“å¼€é€‰æ‹©å¯¹è¯æ¡†
                    newPath = await ipcRenderer.invoke('select-directory');
                }

                if (newPath) {
                    // ä¿å­˜é…ç½®
                    await ipcRenderer.invoke('save-config', {
                        libraryDir: newPath
                    });
                    showNotification(`å·²è®¾ç½®ä¹¦åº“è·¯å¾„: ${newPath}`);
                }
            } catch (error) {
                console.error('è®¾ç½®ä¹¦åº“è·¯å¾„å¤±è´¥:', error);
                if (error !== 'cancelled') {
                    showNotification('è®¾ç½®ä¹¦åº“è·¯å¾„å¤±è´¥: ' + error.message);
                }
            }
        }

        // æ˜¾ç¤ºè¿œç¨‹ç›®å½•é€‰æ‹©å™¨
        function showRemotePathSelector() {
            return new Promise(async (resolve, reject) => {
                // è·å–åˆå§‹è·¯å¾„
                let currentPath = '';
                try {
                    const config = await ipcRenderer.invoke('load-config');
                    currentPath = config.libraryDir || config.baseDir || '';
                } catch (e) { }

                const modal = document.createElement('div');
                modal.className = 'modal';

                // æ¸²æŸ“åˆ—è¡¨å‡½æ•°
                async function renderList(path) {
                    const listContainer = modal.querySelector('.file-list');
                    const pathDisplay = modal.querySelector('.current-path');

                    listContainer.innerHTML = '<div class="loading-spinner" style="margin: 20px auto;"></div>';

                    try {
                        const result = await ipcRenderer.invoke('list-directory', path);

                        if (result.error) {
                            showNotification('æ— æ³•è®¿é—®ç›®å½•: ' + result.error);
                            // å¦‚æœå‡ºé”™ï¼Œå°è¯•å›é€€åˆ°æ ¹ç›®å½•æˆ–ä¸Šçº§
                            return;
                        }

                        currentPath = result.currentPath;
                        pathDisplay.textContent = currentPath;
                        pathDisplay.title = currentPath;

                        listContainer.innerHTML = result.items.map(item => `
                            <div class="file-item ${item.isParent ? 'parent-dir' : ''}" data-path="${item.path.replace(/"/g, '&quot;')}">
                                <span class="file-icon">${item.isParent ? 'â¬†ï¸' : 'ğŸ“'}</span>
                                <span class="file-name">${item.name}</span>
                            </div>
                        `).join('');

                        // ç»‘å®šç‚¹å‡»äº‹ä»¶
                        listContainer.querySelectorAll('.file-item').forEach(item => {
                            item.addEventListener('click', () => {
                                renderList(item.dataset.path);
                            });
                        });

                    } catch (error) {
                        listContainer.innerHTML = `<div style="color:red; padding:10px;">åŠ è½½å¤±è´¥: ${error.message}</div>`;
                    }
                }

                modal.innerHTML = `
                    <div class="modal-content path-selector-modal">
                        <div class="modal-header">
                            <h3>é€‰æ‹©æœåŠ¡å™¨æ–‡ä»¶å¤¹</h3>
                            <span class="modal-close">&times;</span>
                        </div>
                        <div class="path-display-container">
                            <div class="current-path">æ­£åœ¨åŠ è½½...</div>
                        </div>
                        <div class="modal-body custom-scrollbar">
                            <div class="file-list"></div>
                        </div>
                        <div class="modal-footer">
                            <button class="cancel-btn">å–æ¶ˆ</button>
                            <button class="confirm-btn">é€‰æ‹©æ­¤ç›®å½•</button>
                        </div>
                    </div>
                `;

                // æ·»åŠ æ ·å¼
                const style = document.createElement('style');
                style.textContent = `
                    .path-selector-modal {
                        width: 500px;
                        max-width: 90vw;
                        height: 600px;
                        max-height: 80vh;
                        display: flex;
                        flex-direction: column;
                        border-radius: 8px;
                        background: var(--bg-color, #fff);
                    }
                    .dark-mode .path-selector-modal {
                        background: #2d2d2d;
                        border: 1px solid #444;
                    }
                    .path-display-container {
                        padding: 10px 15px;
                        background: rgba(0,0,0,0.03);
                        border-bottom: 1px solid #eee;
                    }
                    .dark-mode .path-display-container {
                        background: rgba(255,255,255,0.03);
                        border-bottom-color: #444;
                    }
                    .current-path {
                        font-family: monospace;
                        white-space: nowrap;
                        overflow: hidden;
                        text-overflow: ellipsis;
                        font-size: 14px;
                        color: #666;
                    }
                    .dark-mode .current-path { color: #aaa; }
                    
                    .file-list { display: flex; flex-direction: column; }
                    .file-item {
                        display: flex;
                        align-items: center;
                        padding: 10px 15px;
                        cursor: pointer;
                        border-bottom: 1px solid #f5f5f5;
                    }
                    .dark-mode .file-item { border-bottom-color: #3d3d3d; }
                    .file-item:hover { background-color: rgba(0,0,0,0.05); }
                    .dark-mode .file-item:hover { background-color: rgba(255,255,255,0.05); }
                    
                    .parent-dir { background-color: rgba(0,0,0,0.02); font-weight: bold; }
                    .dark-mode .parent-dir { background-color: rgba(255,255,255,0.02); }
                    
                    .file-icon { margin-right: 10px; font-size: 18px; }
                    .file-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
                    
                    .modal-footer {
                        padding: 15px;
                        border-top: 1px solid #eee;
                        display: flex;
                        justify-content: flex-end;
                        gap: 10px;
                    }
                    .dark-mode .modal-footer { border-top-color: #444; }
                    
                    .confirm-btn, .cancel-btn {
                        padding: 8px 16px;
                        border-radius: 4px;
                        cursor: pointer;
                        border: none;
                        font-size: 14px;
                    }
                    .confirm-btn { background: #3498db; color: white; }
                    .confirm-btn:hover { background: #2980b9; }
                    .cancel-btn { background: #e0e0e0; color: #333; }
                    .cancel-btn:hover { background: #d0d0d0; }
                    .dark-mode .cancel-btn { background: #444; color: #ddd; }
                    .dark-mode .cancel-btn:hover { background: #555; }
                `;
                modal.appendChild(style);
                document.body.appendChild(modal);

                // åˆå§‹åŠ è½½
                await renderList(currentPath);

                // ç»‘å®šæŒ‰é’®äº‹ä»¶
                const close = () => {
                    if (modal.parentNode) modal.parentNode.removeChild(modal);
                };

                modal.querySelector('.modal-close').addEventListener('click', () => {
                    close();
                    reject('cancelled');
                });

                modal.querySelector('.cancel-btn').addEventListener('click', () => {
                    close();
                    reject('cancelled');
                });

                modal.querySelector('.confirm-btn').addEventListener('click', () => {
                    close();
                    resolve(currentPath);
                });

                // ç‚¹å‡»é®ç½©å…³é—­
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        close();
                        reject('cancelled');
                    }
                });
            });
        }

        // ä¿®æ”¹åŠ è½½é…ç½®çš„å‡½æ•°
        async function loadConfig() {
            try {
                const config = await ipcRenderer.invoke('load-config');
                // ä½¿ç”¨é…ç½®å€¼
                baseDir = config.baseDir || '';
                searchDirs = config.searchDirs || [];

                // ç¡®ä¿å½“å‰baseDirä¹Ÿåœ¨searchDirsä¸­
                if (!searchDirs.includes(baseDir)) {
                    searchDirs.push(baseDir);
                }

                wordsPerPage = config.wordsPerPage || 4000;
                fontSize = config.fontSize || 18;
                homePageFontSize = config.homePageFontSize || 16;

                // åº”ç”¨ä¸»é¢˜è®¾ç½®
                if (config.theme === 'dark') {
                    document.body.classList.add('dark-mode');
                }

                // æ ¹æ®å½“å‰æ¨¡å¼åº”ç”¨å­—ä½“å¤§å°
                if (currentFileName) {
                    // é˜…è¯»æ¨¡å¼
                    document.getElementById('content').style.fontSize = fontSize + 'px';
                } else {
                    // ä¸»é¡µæ¨¡å¼
                    applyHomePageFontSize();
                }

                // å¦‚æœé…ç½®ä¸­ç¦ç”¨äº†æŸäº›åŠŸèƒ½ï¼Œå¯ä»¥éšè—å¯¹åº”æŒ‰é’®
                if (config.hideRandomButton) {
                    const randomButton = document.getElementById('random-book-btn');
                    if (randomButton) {
                        randomButton.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
            }
        }

        // ä¿®æ”¹ä¿å­˜è¿›åº¦çš„å‡½æ•°ï¼Œç¡®ä¿ä¿å­˜ç« èŠ‚ä¿¡æ¯ï¼Œæ”¯æŒå¤šæœ¬ä¹¦
        function saveProgress() {
            if (!currentFileName) return; // å¦‚æœæ²¡æœ‰æ‰“å¼€æ–‡ä»¶ï¼Œä¸ä¿å­˜

            // è·å–æ‰€æœ‰ä¹¦ç±çš„è¿›åº¦è®°å½•
            let allBookProgress = JSON.parse(localStorage.getItem('allBookProgress')) || {};

            // æ›´æ–°å½“å‰ä¹¦ç±çš„è¿›åº¦
            allBookProgress[currentFileName] = {
                page: currentPage,
                chapter: chapters.length > 0 ? currentChapter : 0,  // å¦‚æœæ²¡æœ‰ç« èŠ‚ï¼Œç« èŠ‚å·å§‹ç»ˆä¸º0
                lastRead: new Date().toISOString(),
                hasChapters: chapters.length > 0  // è®°å½•æ˜¯å¦æœ‰ç« èŠ‚
            };

            // ä¿å­˜æ‰€æœ‰ä¹¦ç±çš„è¿›åº¦
            localStorage.setItem('allBookProgress', JSON.stringify(allBookProgress));

            // æ›´æ–°å†å²è®°å½•
            addToHistory({
                fileName: currentFileName,
                date: new Date().toLocaleString(),
                lastPosition: currentPage,
                chapter: chapters.length > 0 ? currentChapter : 0  // å¦‚æœæ²¡æœ‰ç« èŠ‚ï¼Œç« èŠ‚å·å§‹ç»ˆä¸º0
            });
        }

        // æ·»åŠ è¿”å›ä¸»é¡µå‡½æ•°
        function backToHome() {
            currentFileName = '';
            currentPage = 0;
            currentChapter = 0;
            chapters = [];
            updateHistoryDisplay();

            // æ»šåŠ¨åˆ°é¡¶éƒ¨ï¼Œç¡®ä¿é¦–é¡µä»é¡¶éƒ¨å¼€å§‹
            window.scrollTo(0, 0);
            const content = document.getElementById('content');
            if (content) content.scrollTop = 0;

            // åº”ç”¨ä¸»é¡µå­—ä½“å¤§å°
            applyHomePageFontSize();
        }

        // æ·»åŠ éšæœºé˜…è¯»ç›¸å…³å‡½æ•°
        async function loadRandomBook(useCustomPath = false) {
            try {
                // å¦‚æœæŒ‰ä½Ctrlé”®ç‚¹å‡»ï¼Œåªå…è®¸ç”¨æˆ·é€‰æ‹©è‡ªå®šä¹‰è·¯å¾„ï¼Œä¸åŠ è½½ä¹¦ç±
                if (useCustomPath) {
                    await selectCustomPath();
                    return; // é€‰æ‹©å®Œè·¯å¾„åç›´æ¥è¿”å›ï¼Œä¸åŠ è½½ä¹¦ç±
                }

                // æ£€æŸ¥ baseDir æ˜¯å¦æœ‰æ•ˆ
                if (!baseDir) {
                    showNotification('è¯·å…ˆè®¾ç½®éšæœºé˜…è¯»è·¯å¾„ (æŒ‰ä½ Ctrl ç‚¹å‡»æ­¤æŒ‰é’®)');
                    return;
                }

                // æ˜¾ç¤ºåŠ è½½ä¸­çŠ¶æ€
                document.getElementById('loading-overlay').style.display = 'flex';

                // è·å–éšæœºæ–‡ä»¶
                console.log('æ­£åœ¨è·å–éšæœºæ–‡ä»¶ï¼Œè·¯å¾„:', baseDir);
                const filePath = await ipcRenderer.invoke('get-random-file', baseDir);
                if (!filePath) {
                    throw new Error('æ²¡æœ‰æ‰¾åˆ°ä»»ä½• TXT æ–‡ä»¶');
                }

                // è·å–æ–‡ä»¶å†…å®¹
                const data = await ipcRenderer.invoke('read-file', filePath);

                // data å¯èƒ½æ˜¯ Uint8Array (Web) æˆ– Buffer (Electron)
                // è½¬æ¢ä¸º ArrayBuffer
                let arrayBuffer;
                if (data.buffer) {
                    // å¦‚æœæ˜¯ TypedArray æˆ– Buffer
                    // æ³¨æ„ï¼šBuffer.buffer å¯èƒ½æ˜¯å…±äº«çš„ï¼Œæ‰€ä»¥éœ€è¦ slice
                    arrayBuffer = data.buffer.slice(data.byteOffset, data.byteOffset + data.byteLength);
                } else {
                    // å¯èƒ½æ˜¯æ™®é€šæ•°ç»„æˆ–å…¶ä»–
                    arrayBuffer = new Uint8Array(data).buffer;
                }

                // ä½¿ç”¨ processFileContent å¤„ç†å†…å®¹ï¼ˆåŒ…å«è‡ªåŠ¨ç¼–ç æ£€æµ‹ï¼‰
                processFileContent(arrayBuffer, currentFileName);

                document.getElementById('loading-overlay').style.display = 'none';
            } catch (error) {
                console.error('åŠ è½½éšæœºä¹¦ç±å¤±è´¥:', error);
                alert('åŠ è½½éšæœºä¹¦ç±å¤±è´¥: ' + error.message);
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }

        // æ·»åŠ æ‰“å¼€æ–‡ä»¶æ‰€åœ¨ä½ç½®çš„å‡½æ•°
        async function openFileLocation(fileName) {
            try {
                document.getElementById('loading-overlay').style.display = 'flex';
                document.querySelector('.loading-message').textContent = `æ­£åœ¨æŸ¥æ‰¾æ–‡ä»¶: ${fileName}...`;

                // åœ¨æ‰€æœ‰æœç´¢è·¯å¾„ä¸­æŸ¥æ‰¾æ–‡ä»¶
                const searchPaths = [baseDir].concat(searchDirs);

                // æŸ¥æ‰¾æ–‡ä»¶å¹¶æ‰“å¼€å…¶æ‰€åœ¨ç›®å½•
                const result = await ipcRenderer.invoke('find-and-open-file-location', searchPaths, fileName);

                if (result.success) {
                    showNotification(`å·²æ‰“å¼€æ–‡ä»¶æ‰€åœ¨ä½ç½®: ${result.filePath}`);
                } else {
                    showNotification(`æ‰¾ä¸åˆ°æ–‡ä»¶: ${fileName}`);
                }

                document.getElementById('loading-overlay').style.display = 'none';
            } catch (error) {
                console.error('æ‰“å¼€æ–‡ä»¶ä½ç½®å¤±è´¥:', error);
                showNotification('æ‰“å¼€æ–‡ä»¶ä½ç½®å¤±è´¥: ' + error.message);
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }

        // æ·»åŠ é‡ç½®éšæœºçŠ¶æ€çš„å‡½æ•°
        async function resetRandomState() {
            try {
                document.getElementById('loading-overlay').style.display = 'flex';
                document.querySelector('.loading-message').textContent = 'æ­£åœ¨é‡ç½®éšæœºçŠ¶æ€...';

                const result = await ipcRenderer.invoke('reset-random-state');

                if (result) {
                    showNotification('éšæœºçŠ¶æ€å·²é‡ç½®ï¼Œæ‰€æœ‰ä¹¦ç±å°†é‡æ–°å‚ä¸éšæœº');
                } else {
                    showNotification('é‡ç½®éšæœºçŠ¶æ€å¤±è´¥');
                }

                document.getElementById('loading-overlay').style.display = 'none';
            } catch (error) {
                console.error('é‡ç½®éšæœºçŠ¶æ€å¤±è´¥:', error);
                showNotification('é‡ç½®éšæœºçŠ¶æ€å¤±è´¥: ' + error.message);
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }

        // æ˜¾ç¤ºæœåŠ¡å™¨ä¹¦åº“
        async function showServerLibrary() {
            try {
                document.getElementById('loading-overlay').style.display = 'flex';
                document.querySelector('.loading-message').textContent = 'æ­£åœ¨è·å–ä¹¦åº“...';

                const files = await ipcRenderer.invoke('get-file-list');

                document.getElementById('loading-overlay').style.display = 'none';

                if (!files || files.length === 0) {
                    showNotification('ä¹¦åº“ä¸ºç©ºï¼Œè¯·ä¸Šä¼ å°è¯´åˆ° books ç›®å½•');
                    return;
                }

                // ç¦æ­¢èƒŒæ™¯æ»šåŠ¨
                document.body.style.overflow = 'hidden';

                // åˆ›å»ºæ¨¡æ€æ¡†æ˜¾ç¤ºåˆ—è¡¨
                const modal = document.createElement('div');
                modal.className = 'modal';

                // é€’å½’ç”Ÿæˆæ–‡ä»¶æ ‘ HTML
                function generateTreeHtml(items, level = 0) {
                    if (!items || items.length === 0) return '';

                    return items.map(item => {
                        const paddingLeft = level * 24 + 10; // å¢åŠ ç¼©è¿›
                        if (item.type === 'directory') {
                            return `
                                <div class="tree-item directory collapsed">
                                    <div class="tree-content" style="padding-left: ${paddingLeft}px">
                                        <span class="tree-icon">ğŸ“</span>
                                        <span class="tree-name">${item.name}</span>
                                        <span class="tree-meta">${item.children.length} é¡¹</span>
                                    </div>
                                    <div class="tree-children" style="display: none;">
                                        ${generateTreeHtml(item.children, level + 1)}
                                    </div>
                                </div>
                            `;
                        } else {
                            return `
                                <div class="tree-item file" 
                                     data-path="${item.path.replace(/"/g, '&quot;')}" 
                                     data-name="${item.name.replace(/"/g, '&quot;')}">
                                    <div class="tree-content" style="padding-left: ${paddingLeft}px">
                                        <span class="tree-icon">ğŸ“„</span>
                                        <span class="tree-name">${item.name}</span>
                                        <span class="tree-meta">${(item.size / 1024 / 1024).toFixed(2)} MB</span>
                                    </div>
                                </div>
                            `;
                        }
                    }).join('');
                }

                modal.innerHTML = `
                    <div class="modal-content library-modal">
                        <div class="modal-header">
                            <h3>äº‘ç«¯ä¹¦åº“</h3>
                            <span class="modal-close">&times;</span>
                        </div>
                        <div class="modal-body custom-scrollbar">
                            <div class="file-tree">
                                ${generateTreeHtml(files)}
                            </div>
                        </div>
                    </div>
                `;

                // æ·»åŠ æ ·å¼
                const style = document.createElement('style');
                style.textContent = `
                    .library-modal {
                        max-width: 600px; 
                        max-height: 85vh; 
                        display: flex; 
                        flex-direction: column;
                        border-radius: 12px;
                        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                        overflow: hidden;
                        background: var(--bg-color, #fff);
                    }
                    .dark-mode .library-modal {
                        background: #2d2d2d;
                        border: 1px solid #444;
                    }
                    
                    .modal-header {
                        padding: 16px 24px;
                        border-bottom: 1px solid #eee;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        background: rgba(0,0,0,0.02);
                    }
                    .dark-mode .modal-header {
                        border-bottom-color: #444;
                        background: rgba(255,255,255,0.02);
                    }
                    .modal-header h3 { margin: 0; font-size: 18px; font-weight: 600; }
                    
                    .modal-body {
                        overflow-y: auto;
                        flex: 1;
                        padding: 10px 0;
                    }
                    
                    /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
                    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
                    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
                    .custom-scrollbar::-webkit-scrollbar-thumb { background-color: rgba(0,0,0,0.2); border-radius: 3px; }
                    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background-color: rgba(0,0,0,0.3); }
                    .dark-mode .custom-scrollbar::-webkit-scrollbar-thumb { background-color: rgba(255,255,255,0.2); }
                    
                    .file-tree { display: flex; flex-direction: column; }
                    .tree-item { cursor: pointer; user-select: none; }
                    
                    .tree-content { 
                        display: flex; 
                        align-items: center; 
                        padding: 10px 16px 10px 0; /* Left padding is inline */
                        transition: background-color 0.15s;
                        border-left: 3px solid transparent;
                    }
                    .tree-content:hover { 
                        background: rgba(0,0,0,0.04); 
                        border-left-color: var(--primary-color, #3498db);
                    }
                    .dark-mode .tree-content:hover { background: rgba(255,255,255,0.05); }
                    
                    .tree-icon { margin-right: 12px; font-size: 20px; width: 24px; text-align: center; }
                    .tree-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 14px; }
                    .tree-meta { font-size: 12px; color: #999; margin-left: 12px; min-width: 60px; text-align: right; }
                    
                    .directory .tree-icon { color: #f39c12; }
                    .file .tree-icon { color: #3498db; }
                    .dark-mode .file .tree-icon { color: #5dade2; }
                `;
                modal.appendChild(style);

                document.body.appendChild(modal);

                // å…³é—­å‡½æ•°
                const closeModal = () => {
                    document.body.style.overflow = ''; // æ¢å¤æ»šåŠ¨
                    if (modal.parentNode) modal.parentNode.removeChild(modal);
                };

                // ç»‘å®šæ–‡ä»¶å¤¹ç‚¹å‡»äº‹ä»¶ï¼ˆå±•å¼€/æŠ˜å ï¼‰
                modal.querySelectorAll('.directory > .tree-content').forEach(header => {
                    header.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const parent = header.parentElement;
                        const childrenContainer = parent.querySelector('.tree-children');
                        const icon = header.querySelector('.tree-icon');

                        if (childrenContainer.style.display === 'none') {
                            childrenContainer.style.display = 'block';
                            icon.textContent = 'ğŸ“‚'; // æ‰“å¼€çŠ¶æ€å›¾æ ‡
                            parent.classList.remove('collapsed');
                            parent.classList.add('expanded');
                        } else {
                            childrenContainer.style.display = 'none';
                            icon.textContent = 'ğŸ“'; // å…³é—­çŠ¶æ€å›¾æ ‡
                            parent.classList.remove('expanded');
                            parent.classList.add('collapsed');
                        }
                    });
                });

                // ç»‘å®šæ–‡ä»¶ç‚¹å‡»äº‹ä»¶
                modal.querySelectorAll('.file').forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const path = item.getAttribute('data-path');
                        const name = item.getAttribute('data-name');
                        loadServerBook(path, name);
                        closeModal();
                    });
                });

                modal.querySelector('.modal-close').addEventListener('click', closeModal);

                // ç‚¹å‡»é®ç½©å…³é—­
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) closeModal();
                });

            } catch (error) {
                document.getElementById('loading-overlay').style.display = 'none';
                console.error('è·å–ä¹¦åº“å¤±è´¥:', error);
                showNotification('è·å–ä¹¦åº“å¤±è´¥');
            }
        }

        async function loadServerBook(filePath, fileName) {
            try {
                document.getElementById('loading-overlay').style.display = 'flex';
                document.querySelector('.loading-message').textContent = 'æ­£åœ¨åŠ è½½ä¹¦ç±...';

                const data = await ipcRenderer.invoke('read-file', filePath);

                // data å¯èƒ½æ˜¯ Uint8Array (Web) æˆ– Buffer (Electron)
                // è½¬æ¢ä¸º ArrayBuffer
                let arrayBuffer;
                if (data.buffer) {
                    // å¦‚æœæ˜¯ TypedArray æˆ– Buffer
                    // æ³¨æ„ï¼šBuffer.buffer å¯èƒ½æ˜¯å…±äº«çš„ï¼Œæ‰€ä»¥éœ€è¦ slice
                    arrayBuffer = data.buffer.slice(data.byteOffset, data.byteOffset + data.byteLength);
                } else {
                    // å¯èƒ½æ˜¯æ™®é€šæ•°ç»„æˆ–å…¶ä»–
                    arrayBuffer = new Uint8Array(data).buffer;
                }

                processFileContent(arrayBuffer, fileName);

            } catch (error) {
                document.getElementById('loading-overlay').style.display = 'none';
                console.error('åŠ è½½ä¹¦ç±å¤±è´¥:', error);
                showNotification('åŠ è½½ä¹¦ç±å¤±è´¥: ' + error.message);
            }
        }

        // å¤„ç†æ–‡ä»¶å†…å®¹ï¼ˆå¤ç”¨ç°æœ‰çš„ Worker é€»è¾‘ï¼‰
        function processFileContent(buffer, fileName) {
            document.getElementById('loading-overlay').style.display = 'flex';
            document.querySelector('.loading-message').textContent = 'æ­£åœ¨å¤„ç†æ–‡ä»¶å†…å®¹...';

            currentFileName = fileName;

            const fileWorker = createFileWorker();

            fileWorker.onmessage = function (e) {
                const result = e.data;
                if (result.error) {
                    console.error("æ–‡ä»¶å¤„ç†é”™è¯¯:", result.error);
                    alert("æ–‡ä»¶å¤„ç†å¤±è´¥: " + result.error);
                    document.getElementById('loading-overlay').style.display = 'none';
                    return;
                }

                const text = result.text;
                const encoding = result.encoding || 'æœªçŸ¥';

                showNotification(`æ£€æµ‹åˆ°æ–‡ä»¶ç¼–ç : ${encoding}`);

                const allBookProgress = JSON.parse(localStorage.getItem('allBookProgress')) || {};
                if (allBookProgress[currentFileName]) {
                    currentPage = allBookProgress[currentFileName].page;
                    currentChapter = allBookProgress[currentFileName].chapter;
                } else {
                    currentPage = 0;
                    currentChapter = 0;
                }

                document.getElementById('book-title').textContent = fileName.replace('.txt', '');
                document.querySelector('.loading-message').textContent = 'æ­£åœ¨åˆ†æç« èŠ‚ç»“æ„...';
                document.getElementById('content').style.display = 'block';

                detectChapters(text);

                addToHistory({
                    fileName: currentFileName,
                    date: new Date().toLocaleString(),
                    lastPosition: currentPage,
                    chapter: currentChapter
                });
            };

            fileWorker.postMessage({
                buffer: buffer,
                fileName: fileName
            });
        }
    </script>

    <style>
        /* æ·»åŠ æ¨¡æ€å¯¹è¯æ¡†æ ·å¼ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: #fff;
            border-radius: 8px;
            width: 80%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .dark-mode .modal-content {
            background-color: #333;
            color: #ddd;
        }

        .modal-header {
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
        }

        .dark-mode .modal-header {
            border-bottom: 1px solid #555;
        }

        .modal-close {
            font-size: 24px;
            cursor: pointer;
        }

        .modal-body {
            padding: 15px;
        }

        .search-paths-list {
            margin-bottom: 15px;
            max-height: 50vh;
            overflow-y: auto;
        }

        .search-path-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dark-mode .search-path-item {
            border-bottom: 1px solid #555;
        }

        .search-path-delete {
            color: #e74c3c;
            font-size: 18px;
            cursor: pointer;
            padding: 0 5px;
        }

        .search-path-actions {
            margin-top: 15px;
            text-align: center;
        }

        #add-search-path {
            padding: 8px 15px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .dark-mode #add-search-path {
            background-color: #2980b9;
        }
    </style>
</body>

</html>